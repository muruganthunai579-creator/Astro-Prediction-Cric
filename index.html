<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Astro Football ‚Äì Pure Panchapakshi</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <style>
    :root{
      --home-main:#0ea5e9;
      --away-main:#22c55e;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#ffffff;
      color:#111827;
    }
    .wrap{max-width:950px;margin:0 auto;padding:14px;}
    h1{
      font-size:18px;
      letter-spacing:0.28em;
      text-transform:uppercase;
      color:#111827;
      margin:4px 0;
      text-align:center;
    }
    h2{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.22em;
      color:#6b7280;
      margin:0 0 12px 0;
      text-align:center;
    }

    .card{
      background:#f9fafb;
      border-radius:18px;
      padding:14px 14px 16px;
      margin-bottom:14px;
      border:1px solid #e5e7eb;
      box-shadow:0 10px 25px rgba(15,23,42,0.08);
    }
    .title-sm{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.18em;
      color:#6b7280;
      margin-bottom:8px;
    }
    label{
      display:block;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.18em;
      color:#9ca3af;
      margin-bottom:4px;
    }
    input,select{
      width:100%;
      padding:9px 10px;
      border-radius:10px;
      border:1px solid #d1d5db;
      background:#ffffff;
      font-size:13px;
      color:#111827;
      margin-bottom:10px;
    }
    input:focus,select:focus{
      outline:none;
      border-color:#0ea5e9;
      box-shadow:0 0 0 1px #0ea5e9;
    }
    .row{display:flex;gap:10px;flex-wrap:wrap;}
    .row>div{flex:1 1 140px;}

    button{
      border:none;
      border-radius:999px;
      padding:10px 14px;
      font-size:11px;
      font-weight:600;
      letter-spacing:0.18em;
      text-transform:uppercase;
      color:#ffffff;
      cursor:pointer;
      width:100%;
    }
    .btn-main{
      background:linear-gradient(90deg,#2563eb,#22c55e);
      box-shadow:0 10px 22px rgba(37,99,235,.4);
    }
    .btn-dark{
      background:linear-gradient(90deg,#111827,#4b5563);
      box-shadow:0 8px 18px rgba(15,23,42,.45);
    }
    .btn-green{
      background:linear-gradient(90deg,#16a34a,#22c55e);
      box-shadow:0 8px 18px rgba(34,197,94,.45);
    }
    .btn-auto{
      width:auto;
      padding:8px 14px;
      font-size:10px;
      align-self:flex-end;
      white-space:nowrap;
    }
    button:active{transform:scale(.97);}

    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      margin-top:6px;
    }
    th,td{
      border:1px solid #e5e7eb;
      padding:4px 6px;
      text-align:left;
      white-space:nowrap;
    }
    th{
      background:#e5f3ff;
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-size:10px;
      color:#374151;
    }
    tr:nth-child(even){background:#ffffff;}
    tr:nth-child(odd){background:#f9fafb;}
    tr.live-row td{
      background:#fee2e2;
    }

    .tiny{
      font-size:11px;
      color:#6b7280;
      line-height:1.55;
      margin-top:6px;
    }

    .tag{
      display:inline-block;
      padding:2px 8px;
      border-radius:999px;
      font-size:10px;
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.12em;
      margin-right:6px;
    }
    .tag-info{background:#e0f2fe;color:#0369a1;}
    .tag-flow{background:#e0f2fe;color:#075985;}
    .tag-draw{background:#fee2e2;color:#b91c1c;}
    .tag-score{background:#fef3c7;color:#92400e;}
    .tag-overall{background:#bbf7d0;color:#166534;}

    .home-text{color:var(--home-main);font-weight:600;}
    .away-text{color:var(--away-main);font-weight:600;}
    .excellent-text{color:#15803d;font-weight:700;}
    .weak-text{color:#dc2626;font-weight:600;}
    .good-text{color:#16a34a;font-weight:600;}
    .pass-text{color:#16a34a;font-weight:700;}
    .fail-text{color:#dc2626;font-weight:700;}

    .bar-wrap{
      width:100%;
      height:16px;
      border-radius:999px;
      overflow:hidden;
      background:#e5e7eb;
      border:1px solid #d1d5db;
      margin:6px 0 4px 0;
      display:flex;
      position:relative;
    }
    .bar-fill{height:100%;}
    .bar-home{
      background:linear-gradient(90deg,var(--home-main),#38bdf8);
    }
    .bar-away{
      background:linear-gradient(90deg,var(--away-main),#22c55e);
    }
    .bar-midline{
      position:absolute;
      top:-1px;
      bottom:-1px;
      width:2px;
      background:#f97316;
      opacity:0.9;
      pointer-events:none;
    }
    .bar-label{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      font-size:10px;
      font-weight:600;
      white-space:nowrap;
      color:#ffffff;
      text-shadow:0 1px 2px rgba(0,0,0,0.6);
    }

    #matchTableWrap{
      max-height:260px;
      overflow:auto;
      border-radius:12px;
      border:1px solid #e5e7eb;
      margin-top:8px;
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>ASTRO FOOTBALL</h1>
  <h2>PURE PANCHAPAKSHI ¬∑ FOOTBALL ONLY ¬∑ RULE LOCK</h2>

  <!-- STEP 1 : API-FOOTBALL -->
  <div class="card">
    <div class="title-sm">Step 1 ¬∑ Load Football Matches (API-Football)</div>
    <div class="row">
      <div>
        <label>API key (dashboard.api-football.com)</label>
        <input id="apiKey" placeholder="Paste your API key" />
      </div>
      <div>
        <label>Day</label>
        <input id="apiDay" type="date" />
      </div>
    </div>
    <div class="row">
      <div>
        <button class="btn-main" onclick="loadMatches()">Load Matches</button>
      </div>
    </div>
    <div id="apiInfo" class="tiny">
      Paste your API key & pick day ‚Üí click <b>Load Matches</b>.  
      Red row = LIVE now. Only today LIVE + upcoming matches are shown.
    </div>

    <div id="matchTableWrap" style="display:none;">
      <table>
        <thead>
          <tr>
            <th>Kickoff</th>
            <th>Home</th>
            <th>Away</th>
            <th>City</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="matchTableBody"></tbody>
      </table>
    </div>
  </div>

  <!-- STEP 2 : MATCH INPUT -->
  <div class="card">
    <div class="title-sm">Step 2 ¬∑ Match Input (from API row or manual)</div>
    <div class="row">
      <div>
        <label>Home team</label>
        <input id="homeTeam" placeholder="Home team name" />
      </div>
      <div>
        <label>Away team</label>
        <input id="awayTeam" placeholder="Away team name" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Kickoff date (venue)</label>
        <input id="kickoffDate" type="date" />
      </div>
      <div>
        <label>Kickoff time (venue)</label>
        <input id="kickoffTime" type="time" value="20:00" />
      </div>
    </div>
    <div class="row">
      <div>
        <label>Venue timezone (from API)</label>
        <input id="venueTz" placeholder="Ex: Europe/London" />
      </div>
      <div>
        <label>League / competition</label>
        <input id="league" placeholder="Ex: Premier League" />
      </div>
      <div>
        <label>City / country</label>
        <input id="city" placeholder="Ex: Liverpool, England" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Paksha (auto from date)</label>
        <select id="paksha" disabled>
          <option value="shukla">Shukla</option>
          <option value="krishna">Krishna</option>
        </select>
      </div>
      <div style="flex:1.4;display:flex;justify-content:flex-end;align-items:flex-end;">
        <button class="btn-dark btn-auto" onclick="autoTeamBirds()">Auto team birds from name (LOCK)</button>
      </div>
    </div>

    <div id="dayInfo" class="tiny"></div>
    <div id="birdLockInfo" class="tiny"></div>
  </div>

  <!-- STEP 3 : PURE PANCHAPAKSHI PREDICTION -->
  <div class="card">
    <div class="title-sm">Step 3 ¬∑ Pure Panchapakshi Prediction (Auto Lock)</div>
    <div class="row">
      <div>
        <button class="btn-green" onclick="runPrediction()">Run Panchapakshi Prediction</button>
      </div>
    </div>
    <div id="waitLine" class="tiny">Waiting for match input‚Ä¶</div>
    <div id="summaryBox" class="tiny"></div>
  </div>

  <!-- TIMELINE (optional ‚Äì not used now but kept for layout) -->
  <div id="timelineCard" class="card" style="display:none;">
    <div class="title-sm">Match Flow ‚Äì Panchapakshi Environment (IST)</div>
    <div id="timelineContainer"></div>
  </div>

  <!-- STEP 4 ¬∑ PREDICTION HISTORY (PASS / FAIL) ‚Äì ALWAYS LAST -->
  <div class="card" id="historyCard">
    <div class="title-sm">Prediction History ‚Äì Pass / Fail</div>

    <div class="tiny">
      Saved only in this browser (local storage).  
      After matches finish, press <b>Update Finished Results</b>.
    </div>

    <button class="btn-main"
            style="margin-top:8px;margin-bottom:8px;"
            onclick="updateFinishedResultsFromApi()">
      UPDATE FINISHED RESULTS (API)
    </button>

    <table id="historyTable">
      <thead>
        <tr>
          <th>Date</th>
          <th>Match</th>
          <th>Your Call</th>
          <th>Final Score</th>
          <th>Status</th>
        </tr>
      </thead>
      <tbody id="historyBody">
        <!-- filled by JS -->
      </tbody>
    </table>
  </div>
</div>

<script>
  const $ = id => document.getElementById(id);

  function todayISO(){
    const d = new Date();
    return d.toISOString().slice(0,10);
  }

  // Prediction history
  const HISTORY_KEY = 'astroFootballHistory';
  let predictionHistory = [];
  let currentFixtureId = null;

  // Panchapakshi data
  const BIRDS = ['Vulture','Owl','Crow','Cock','Peacock'];

  const NAKSHATRA_BIRDS = [
    'Peacock','Peacock','Peacock','Peacock','Peacock',
    'Cock','Cock','Cock','Cock','Cock','Cock',
    'Crow','Crow','Crow','Crow','Crow',
    'Owl','Owl','Owl','Owl','Owl',
    'Vulture','Vulture','Vulture','Vulture','Vulture','Vulture'
  ];

  const FRIENDLY_BIRDS = {
    Vulture: ['Owl','Cock'],
    Owl:     ['Vulture','Peacock'],
    Crow:    ['Peacock','Cock'],
    Cock:    ['Vulture','Crow'],
    Peacock: ['Owl','Crow']
  };
  const UNFRIENDLY_BIRDS = {
    Vulture: ['Peacock','Crow'],
    Owl:     ['Crow','Cock'],
    Crow:    ['Vulture','Owl'],
    Cock:    ['Peacock','Owl'],
    Peacock: ['Vulture','Cock']
  };

  const DAY_PLANETS = ['Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn'];

  const BIRD_PLANETS = {
    shukla: {
      Vulture: ['Jupiter','Saturn'],
      Owl:     ['Sun','Venus'],
      Crow:    ['Moon'],
      Cock:    ['Mars'],
      Peacock: ['Mercury']
    },
    krishna: {
      Vulture: ['Mars'],
      Owl:     ['Moon'],
      Crow:    ['Sun'],
      Cock:    ['Jupiter','Saturn'],
      Peacock: ['Mercury','Venus']
    }
  };

  function deriveRulingBirds(paksha){
    const map = BIRD_PLANETS[paksha];
    const res = [];
    for(let d=0; d<7; d++){
      const planet = DAY_PLANETS[d];
      let chosen='Vulture';
      for(const b of BIRDS){
        if((map[b]||[]).includes(planet)){chosen=b;break;}
      }
      res.push(chosen);
    }
    return res;
  }

  const RULING_BIRDS = {
    shukla: deriveRulingBirds('shukla'),
    krishna: deriveRulingBirds('krishna')
  };

  // Rule lock scores
  const ACTIVITY_SCORES = {
    Rule:100,
    Eat:80,
    Walk:50,
    Sleep:30,
    Die:0
  };

  // Numerology ‚Üí bird
  const CHALDEAN = {
    1:['A','I','J','Q','Y'],
    2:['B','K','R'],
    3:['C','G','L','S'],
    4:['D','M','T'],
    5:['E','H','N','X'],
    6:['U','V','W'],
    7:['O','Z'],
    8:['F','P']
  };
  const CHAR_TO_NUM = {};
  Object.keys(CHALDEAN).forEach(num=>{
    CHALDEAN[num].forEach(ch=>CHAR_TO_NUM[ch]=Number(num));
  });

  function nameNumerology(name){
    let sum=0;
    const up = name.toUpperCase();
    for(const ch of up){
      if(CHAR_TO_NUM[ch]) sum+=CHAR_TO_NUM[ch];
    }
    while(sum>9){
      let s=0;
      for(const d of String(sum)) s+=Number(d);
      sum=s;
    }
    return sum;
  }

  function birdFromName(name){
    const n = nameNumerology(name);
    if(!n) return 'Vulture';
    const idx = ((n-1)*3) % 27;
    return NAKSHATRA_BIRDS[idx];
  }

  function computeMoonAge(date){
    const year=date.getUTCFullYear();
    const month=date.getUTCMonth()+1;
    const day=date.getUTCDate();
    let yy = year - Math.floor((12 - month)/10);
    let mm = month + 9;
    if(mm>=12) mm -= 12;
    const k1 = Math.floor(365.25*(yy+4712));
    const k2 = Math.floor(30.6*mm+0.5);
    const k3 = Math.floor(Math.floor((yy/100)+49)*0.75) - 38;
    const jd = k1 + k2 + day + 59 - k3;
    const ip = (jd - 2451550.1)/29.530588853;
    const frac = ip - Math.floor(ip);
    return frac*29.530588853;
  }

  function updatePakshaAndDayInfo(){
    const dateStr = $('kickoffDate').value;
    if(!dateStr){
      $('dayInfo').textContent = 'Select kickoff date to auto-set paksha & day ruling bird.';
      return;
    }
    const d = new Date(dateStr + 'T12:00:00');
    const age = computeMoonAge(d);
    const paksha = age < 14.765 ? 'shukla' : 'krishna';
    $('paksha').value = paksha;

    const dayIdx = d.getDay();
    const dow = ['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'][dayIdx];
    const dayBird = RULING_BIRDS[paksha][dayIdx];
    const friendly = FRIENDLY_BIRDS[dayBird] || [];
    const enemy = UNFRIENDLY_BIRDS[dayBird] || [];

    $('dayInfo').innerHTML =
      `<span class="tag tag-info">Day Bird</span>`+
      `${dow} ¬∑ Paksha: ${paksha[0].toUpperCase()+paksha.slice(1)} ¬∑ `+
      `Ruling bird: <span class="excellent-text">${dayBird}</span> ¬∑ `+
      `Friendly: <span class="good-text">${friendly.join(', ')||'-'}</span> ¬∑ `+
      `Enemy: <span class="weak-text">${enemy.join(', ')||'-'}</span>`;
  }

  let homeBirdLocked = null;
  let awayBirdLocked = null;

  function autoTeamBirds(){
    const home = $('homeTeam').value.trim();
    const away = $('awayTeam').value.trim();
    const dateStr = $('kickoffDate').value;
    if(!home || !away || !dateStr){
      alert('Enter home team, away team and kickoff date first.');
      return;
    }
    const hb = birdFromName(home);
    const ab = birdFromName(away);

    homeBirdLocked = hb;
    awayBirdLocked = ab;

    $('birdLockInfo').innerHTML =
      `<span class="tag tag-flow">Auto team birds (locked)</span>`+
      `<span class="home-text">${home}</span> ‚Üí <b>${hb}</b> ¬∑ `+
      `<span class="away-text">${away}</span> ‚Üí <b>${ab}</b><br>`+
      `Name ‚Üí numerology ‚Üí 27 nakshatra ‚Üí bird. Manual change not allowed üîí`;
  }

  function calcEnvPercent(homeBird, awayBird, dateStr, timeStr, paksha){
    const d = new Date(dateStr + 'T12:00:00');
    const dayIdx = d.getDay();
    const dayBird = RULING_BIRDS[paksha][dayIdx];

    function relationActivity(bird){
      if(bird === dayBird) return 'Rule';
      if((FRIENDLY_BIRDS[dayBird]||[]).includes(bird)) return 'Eat';
      if((UNFRIENDLY_BIRDS[dayBird]||[]).includes(bird)) return 'Die';
      return 'Walk';
    }

    const homeAct = relationActivity(homeBird);
    const awayAct = relationActivity(awayBird);
    const sH = ACTIVITY_SCORES[homeAct];
    const sA = ACTIVITY_SCORES[awayAct];
    const tot = sH + sA || 1;

    return {
      home: (sH/tot)*100,
      away: (sA/tot)*100,
      homeAct,
      awayAct,
      dayBird
    };
  }

  function makeBar(pHome, pAway, homeLabel, awayLabel){
    const left = pHome;
    return `
      <div class="bar-wrap">
        <div class="bar-midline" style="left:${left}%;"></div>
        <div class="bar-fill bar-home" style="width:${pHome}%;"></div>
        <div class="bar-fill bar-away" style="width:${pAway}%;"></div>
        <div class="bar-label">
          <span class="home-text">${homeLabel}</span> ‚Ä¢
          <span class="away-text">${awayLabel}</span>
        </div>
      </div>`;
  }

  function runPrediction(){
    const home = $('homeTeam').value.trim();
    const away = $('awayTeam').value.trim();
    const date = $('kickoffDate').value;
    const time = $('kickoffTime').value || '20:00';

    if (!home || !away || !date) {
      alert('Fill home team, away team, date & time first.');
      return;
    }

    if (!homeBirdLocked || !awayBirdLocked) {
      autoTeamBirds();
      if(!homeBirdLocked || !awayBirdLocked) return;
    }

    const paksha = $('paksha').value;
    const d = new Date(date + 'T12:00:00');
    const dayIdx = d.getDay();
    const dayBird = RULING_BIRDS[paksha][dayIdx];
    const friendly = FRIENDLY_BIRDS[dayBird] || [];
    const enemy = UNFRIENDLY_BIRDS[dayBird] || [];

    function baseStrength(bird){
      let s = 50;
      if(bird === dayBird) s += 40;
      else if(friendly.includes(bird)) s += 20;
      else if(enemy.includes(bird)) s -= 20;
      return s;
    }

    const env = calcEnvPercent(homeBirdLocked, awayBirdLocked, date, time, paksha);

    let homeRaw = env.home + baseStrength(homeBirdLocked);
    let awayRaw = env.away + baseStrength(awayBirdLocked);
    const totRaw = homeRaw + awayRaw || 1;

    let homePct = (homeRaw / totRaw) * 100;
    let awayPct = 100 - homePct;

    const clamp = p => p>70 ? 70 : (p<30 ? 30 : p);
    homePct = clamp(homePct);
    awayPct = 100 - homePct;

    if (homePct === awayPct){
      homePct += 0.5;
      awayPct -= 0.5;
    }

    const diff = homePct - awayPct;

    // Draw engine (activity + bird)
    const homeScoreAct = ACTIVITY_SCORES[env.homeAct];
    const awayScoreAct = ACTIVITY_SCORES[env.awayAct];
    const actDiff = Math.abs(homeScoreAct - awayScoreAct);
    const sameBird = homeBirdLocked === awayBirdLocked;
    const sameActivity = env.homeAct === env.awayAct;

    let drawFlag = 'NO';  // YES / MAYBE / NO
    if (sameBird || sameActivity || actDiff <= 20) {
      drawFlag = 'YES';
    } else if (actDiff <= 30 || Math.abs(diff) <= 8) {
      drawFlag = 'MAYBE';
    } else {
      drawFlag = 'NO';
    }

    let drawText;
    if (drawFlag === 'YES') {
      drawText = 'YES ‚Äì birds / activity nearly equal.';
    } else if (drawFlag === 'MAYBE') {
      drawText = 'YES / MAYBE ‚Äì powers close, draw possible.';
    } else {
      drawText = 'NO ‚Äì one bird clearly stronger.';
    }

    const drawLikely = drawFlag !== 'NO';

    const envBar = makeBar(
      homePct,
      awayPct,
      `${home} ${homePct.toFixed(1)}%`,
      `${away} ${awayPct.toFixed(1)}%`
    );

    let scoreHint = '';
    const strongSidePct = diff >= 0 ? homePct : awayPct;

    if (drawLikely) {
      if (env.home < 55 && env.away < 55) {
        scoreHint = '0‚Äì0 or 1‚Äì1 (low activity draw).';
      } else {
        scoreHint = '1‚Äì1 or 2‚Äì2 (open draw).';
      }
    } else {
      if (strongSidePct >= 65) {
        scoreHint = diff > 0 ? 'Home win: 2‚Äì0 or 3‚Äì1.' : 'Away win: 0‚Äì2 or 1‚Äì3.';
      } else if (strongSidePct >= 58) {
        scoreHint = diff > 0 ? 'Home edge: 1‚Äì0 or 2‚Äì1.' : 'Away edge: 0‚Äì1 or 1‚Äì2.';
      } else {
        scoreHint = 'Very tight score ‚Äì 1 goal difference.';
      }
    }

    const winner = diff >= 0 ? home : away;

    let homeClass = 'home-text';
    let awayClass = 'away-text';
    if (winner === home){
      homeClass = 'excellent-text';
      awayClass = 'weak-text';
    } else {
      homeClass = 'weak-text';
      awayClass = 'excellent-text';
    }

    $('waitLine').style.display = 'none';
    $('summaryBox').innerHTML =
      `<div class="summary-line tiny">
         <span class="tag tag-flow">Team birds (LOCK)</span>
         <span class="home-text">${home}</span> ‚Üí <b>${homeBirdLocked}</b> ¬∑
         <span class="away-text">${away}</span> ‚Üí <b>${awayBirdLocked}</b>
       </div>
       <div class="summary-line tiny">
         <span class="tag tag-flow">Match flow (Panchapakshi)</span>
         ${envBar}
         <br>Home activity: <b>${env.homeAct}</b> ¬∑ Away activity: <b>${env.awayAct}</b>
       </div>
       <div class="summary-line tiny">
         <span class="tag tag-draw">Draw?</span>
         <b>${drawText}</b>
       </div>
       <div class="summary-line tiny">
         <span class="tag tag-score">Correct score</span>
         <b>${scoreHint}</b>
       </div>
       <div class="summary-line tiny">
         <span class="tag tag-overall">Overall winner</span>
         <span class="${homeClass}">${home}</span> ${homePct.toFixed(1)}% ¬∑
         <span class="${awayClass}">${away}</span> ${awayPct.toFixed(1)}%<br>
         Final call: <span class="excellent-text">${winner}</span>
       </div>`;

    // Save to history
    const league = $('league').value || '';
    const city = $('city').value || '';
    savePredictionResult({
      fixtureId: currentFixtureId || null,
      date,
      homeTeam: home,
      awayTeam: away,
      league,
      city,
      predictedWinner: winner,
      predictedDraw: drawFlag,
      scoreHint
    });
    renderHistoryTable();
  }

  // History functions
  function loadHistoryFromStorage() {
    try {
      const raw = localStorage.getItem(HISTORY_KEY);
      predictionHistory = raw ? JSON.parse(raw) : [];
    } catch (e) {
      predictionHistory = [];
    }
  }

  function saveHistoryToStorage() {
    try {
      localStorage.setItem(HISTORY_KEY, JSON.stringify(predictionHistory));
    } catch (e) {}
  }

  function savePredictionResult(obj) {
    if (!obj.homeTeam || !obj.awayTeam) return;

    const record = {
      id: Date.now(),
      fixtureId: obj.fixtureId,
      date: obj.date || '',
      homeTeam: obj.homeTeam,
      awayTeam: obj.awayTeam,
      league: obj.league || '',
      city: obj.city || '',
      predictedWinner: obj.predictedWinner,
      predictedDraw: obj.predictedDraw,
      scoreHint: obj.scoreHint || '',
      actualScore: null,
      actualWinner: null,
      passStatus: 'PENDING',      // PENDING / PASS / FAIL / NEUTRAL
      fixtureStatus: null,
      checked: false
    };

    predictionHistory.unshift(record);
    if (predictionHistory.length > 100) predictionHistory.pop();

    saveHistoryToStorage();
  }

  function renderHistoryTable() {
    const body = document.getElementById('historyBody');
    if (!body) return;
    body.innerHTML = '';

    if (!predictionHistory.length) {
      body.innerHTML = '<tr><td colspan="5">No predictions saved yet.</td></tr>';
      return;
    }

    predictionHistory.forEach(rec => {
      const tr = document.createElement('tr');
      const matchLabel = `${rec.homeTeam} vs ${rec.awayTeam}`;
      const callText = rec.predictedWinner;

      let statusHtml = '';
      if (rec.passStatus === 'PASS') {
        statusHtml = '<span class="pass-text">PASS ‚úÖ</span>';
      } else if (rec.passStatus === 'FAIL') {
        statusHtml = '<span class="fail-text">FAIL ‚ùå</span>';
      } else if (rec.passStatus === 'NEUTRAL') {
        statusHtml = '<span style="color:#6b7280;">Neutral</span>';
      } else {
        statusHtml = '<span style="color:#9ca3af;">Pending‚Ä¶</span>';
      }

      tr.innerHTML = `
        <td>${rec.date || '-'}</td>
        <td>${matchLabel}</td>
        <td>${callText}</td>
        <td>${rec.actualScore || '-'}</td>
        <td>${statusHtml}</td>
      `;
      body.appendChild(tr);
    });
  }

  async function updateFinishedResultsFromApi() {
    const apiKeyInput = document.getElementById('apiKey');
    if (!apiKeyInput || !apiKeyInput.value) {
      alert('First enter your API key in Step 1.');
      return;
    }
    const apiKey = apiKeyInput.value.trim();

    const pending = predictionHistory.filter(
      r => r.fixtureId && !r.checked
    );
    if (!pending.length) {
      alert('Nothing to update. All saved predictions already checked or have no fixture id.');
      return;
    }

    for (const rec of pending) {
      try {
        const url = `https://v3.football.api-sports.io/fixtures?id=${rec.fixtureId}`;
        const res = await fetch(url, {
          headers: { 'x-apisports-key': apiKey }
        });
        const data = await res.json();
        if (!data.response || !data.response.length) continue;

        const fixt = data.response[0];
        const statusShort = fixt.fixture.status.short;
        const homeGoals = fixt.goals.home;
        const awayGoals = fixt.goals.away;

        if (statusShort === 'FT' || statusShort === 'AET' || statusShort === 'PEN') {
          let actualWinner = 'DRAW';
          if (homeGoals > awayGoals) actualWinner = 'HOME';
          else if (awayGoals > homeGoals) actualWinner = 'AWAY';

          let predictedKey = 'DRAW';
          const txt = (rec.predictedWinner || '').toLowerCase();
          if (txt.includes(rec.homeTeam.toLowerCase())) predictedKey = 'HOME';
          else if (txt.includes(rec.awayTeam.toLowerCase())) predictedKey = 'AWAY';
          else if (txt.includes('balanced') || txt.includes('50-50')) predictedKey = 'BALANCED';

          let passStatus = 'FAIL';
          if (predictedKey === 'BALANCED') {
            passStatus = 'NEUTRAL';
          } else if (predictedKey === actualWinner) {
            passStatus = 'PASS';
          }

          rec.actualScore = `${homeGoals} ‚Äì ${awayGoals}`;
          rec.actualWinner = actualWinner;
          rec.passStatus = passStatus;
          rec.fixtureStatus = statusShort;
          rec.checked = true;
        }
      } catch (e) {
        console.error('History update error', e);
      }
    }

    saveHistoryToStorage();
    renderHistoryTable();
    alert('Finished matches updated (where possible).');
  }

  function loadMatches(){
    const key = $('apiKey').value.trim();
    const day = $('apiDay').value;
    if(!key){
      alert('Paste your API key first.');
      return;
    }
    const dateStr = day || todayISO();
    $('apiDay').value = dateStr;

    const url = `https://v3.football.api-sports.io/fixtures?date=${dateStr}&timezone=UTC`;

    $('apiInfo').textContent = 'Calling API‚Ä¶ please wait.';
    $('matchTableWrap').style.display = 'none';
    $('matchTableBody').innerHTML = '';

    fetch(url,{
      headers:{ 'x-apisports-key': key }
    })
    .then(r=>{
      if(!r.ok) throw new Error('HTTP '+r.status);
      return r.json();
    })
    .then(data=>{
      if(!data || !Array.isArray(data.response)){
        throw new Error('Unexpected API response');
      }
      const rows = [];
      const now = Date.now()/1000;
      data.response.forEach(item=>{
        const f = item.fixture;
        const l = item.league;
        const teams = item.teams;
        const status = f.status.short;
        const finishedCodes = ['FT','AET','PEN','CANC','PST','ABD','AWD','WO'];
        if(finishedCodes.includes(status)) return;

        const ts = f.timestamp;
        if (Math.abs(ts-now) > 60*60*18) return;

        rows.push({
          fixtureId: f.id,
          kick: f.date.slice(11,16) + ' UTC',
          home: teams.home.name,
          away: teams.away.name,
          city: (f.venue && f.venue.city) || (l && l.country) || '',
          league: l ? l.name : '',
          statusShort: status,
          statusLong: f.status.long,
          timezone: 'UTC',
          dateISO: f.date.slice(0,10)
        });
      });

      if(!rows.length){
        $('apiInfo').textContent = 'API call success ‚Äì but no LIVE / upcoming fixtures for this day (after filtering).';
        return;
      }

      const tbody = $('matchTableBody');
      rows.forEach(row=>{
        const tr = document.createElement('tr');
        if(row.statusShort==='1H' || row.statusShort==='2H' || row.statusShort==='LIVE'){
          tr.classList.add('live-row');
        }
        tr.innerHTML =
          `<td>${row.dateISO} ${row.kick}</td>
           <td>${row.home}</td>
           <td>${row.away}</td>
           <td>${row.city}</td>
           <td>${row.statusLong}</td>`;
        tr.addEventListener('click',()=>{
          currentFixtureId = row.fixtureId;
          $('homeTeam').value = row.home;
          $('awayTeam').value = row.away;
          $('kickoffDate').value = row.dateISO;
          $('kickoffTime').value = row.kick.slice(0,5);
          $('venueTz').value = row.timezone;
          $('league').value = row.league;
          $('city').value = row.city;
          updatePakshaAndDayInfo();
          homeBirdLocked = null;
          awayBirdLocked = null;
          $('birdLockInfo').textContent = 'Paksha & team birds will be locked automatically from match date + team name (numerology ‚Üí 27 nakshatra ‚Üí bird).';
          $('waitLine').style.display = 'block';
          $('summaryBox').innerHTML = '';
        });
        tbody.appendChild(tr);
      });

      $('matchTableWrap').style.display = 'block';
      $('apiInfo').textContent = 'API call success. Click any row below to send the match into Step 2.';
    })
    .catch(err=>{
      console.error(err);
      $('apiInfo').textContent = 'Network / API error. Check internet + key + quota. ('+err.message+')';
      alert('Network / API error ‚Äì check key / quota in dashboard.');
    });
  }

  (function init(){
    $('apiDay').value = todayISO();
    $('kickoffDate').value = todayISO();
    updatePakshaAndDayInfo();
    $('kickoffDate').addEventListener('change',()=>{
      updatePakshaAndDayInfo();
      homeBirdLocked = null;
      awayBirdLocked = null;
      $('birdLockInfo').textContent = '';
      $('waitLine').style.display = 'block';
      $('summaryBox').innerHTML = '';
    });
    loadHistoryFromStorage();
    renderHistoryTable();
  })();
</script>
</body>
</html>
```Ó®Å0Ó®Ç
