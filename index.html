<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Astro Football Â· Pure Panchapakshi Â· Football Only Â· API Mode</title>
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <style>
    :root {
      --green: #16a34a;
      --green-dark: #15803d;
      --blue: #2563eb;
      --red: #dc2626;
      --amber: #f59e0b;
      --gray-50: #f9fafb;
      --gray-100: #f3f4f6;
      --gray-200: #e5e7eb;
      --gray-300: #d1d5db;
      --gray-500: #6b7280;
      --gray-700: #374151;
      --gray-900: #111827;
    }

    * {
      box-sizing: border-box;
    }

    body {
      margin: 0;
      padding: 0;
      font-family: system-ui, -apple-system, BlinkMacSystemFont, "Segoe UI", sans-serif;
      background: #ffffff;
      color: var(--gray-900);
    }

    .page {
      max-width: 960px;
      margin: 0 auto;
      padding: 16px;
    }

    h1 {
      text-align: center;
      margin: 8px 0 4px;
      font-size: 1.7rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
    }

    .subtitle {
      text-align: center;
      font-size: 0.8rem;
      letter-spacing: 0.15em;
      text-transform: uppercase;
      color: var(--gray-500);
      margin-bottom: 16px;
    }

    .card {
      background: #ffffff;
      border-radius: 18px;
      border: 1px solid var(--gray-200);
      padding: 16px 16px 18px;
      margin-bottom: 16px;
      box-shadow: 0 8px 18px rgba(15, 23, 42, 0.06);
    }

    .section-title {
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.14em;
      text-transform: uppercase;
      color: var(--gray-700);
      margin-bottom: 10px;
    }

    .section-sub {
      font-size: 0.78rem;
      color: var(--gray-500);
      margin-bottom: 10px;
    }

    label {
      display: block;
      font-size: 0.78rem;
      font-weight: 600;
      color: var(--gray-700);
      margin-bottom: 4px;
    }

    input[type="text"],
    input[type="date"],
    input[type="time"],
    select {
      width: 100%;
      padding: 8px 10px;
      border-radius: 10px;
      border: 1px solid var(--gray-300);
      font-size: 0.86rem;
      color: var(--gray-900);
    }

    input:focus,
    select:focus {
      outline: none;
      border-color: var(--green);
      box-shadow: 0 0 0 1px rgba(34, 197, 94, 0.15);
    }

    .row {
      display: flex;
      gap: 10px;
      flex-wrap: wrap;
    }

    .col-2 {
      flex: 1 1 0;
      min-width: 0;
    }

    .btn {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 10px 16px;
      border-radius: 999px;
      border: none;
      font-size: 0.9rem;
      font-weight: 700;
      letter-spacing: 0.12em;
      text-transform: uppercase;
      cursor: pointer;
      color: #ffffff;
      background-image: linear-gradient(90deg, var(--green-dark), var(--green));
      box-shadow: 0 8px 18px rgba(22, 163, 74, 0.4);
    }

    .btn-small {
      padding: 8px 12px;
      font-size: 0.78rem;
    }

    .btn-blue {
      background-image: linear-gradient(90deg, #1d4ed8, #0ea5e9);
      box-shadow: 0 8px 18px rgba(37, 99, 235, 0.35);
    }

    .btn-block {
      width: 100%;
    }

    .btn:active {
      transform: translateY(1px);
      box-shadow: 0 4px 10px rgba(22, 163, 74, 0.3);
    }

    .pill {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      padding: 4px 10px;
      border-radius: 999px;
      font-size: 0.7rem;
      font-weight: 700;
      text-transform: uppercase;
      letter-spacing: 0.14em;
      border: 1px solid transparent;
      background: var(--gray-100);
      color: var(--gray-700);
    }

    .pill-green {
      background: #dcfce7;
      color: var(--green-dark);
      border-color: #bbf7d0;
    }

    .pill-amber {
      background: #fef3c7;
      color: #92400e;
      border-color: #fde68a;
    }

    .pill-red {
      background: #fee2e2;
      color: #991b1b;
      border-color: #fecaca;
    }

    .pill-blue {
      background: #dbeafe;
      color: #1d4ed8;
      border-color: #bfdbfe;
    }

    .helper-text {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: 4px;
    }

    table {
      width: 100%;
      border-collapse: collapse;
      font-size: 0.8rem;
    }

    thead {
      position: sticky;
      top: 0;
      background: #ffffff;
      z-index: 1;
    }

    th,
    td {
      padding: 6px 6px;
      border-bottom: 1px solid var(--gray-200);
      text-align: left;
      white-space: nowrap;
    }

    th {
      font-size: 0.75rem;
      text-transform: uppercase;
      letter-spacing: 0.12em;
      color: var(--gray-500);
      background: var(--gray-50);
    }

    .table-scroll {
      max-height: 360px;
      overflow-y: auto;
      border-radius: 12px;
      border: 1px solid var(--gray-200);
    }

    .match-row {
      cursor: pointer;
    }

    .match-row:nth-child(odd) {
      background: #fcfcff;
    }

    .match-row:hover {
      background: #e0f2fe;
    }

    #apiMessage {
      font-size: 0.78rem;
      margin-top: 6px;
    }

    .flow-wrapper {
      margin-top: 10px;
      border-radius: 999px;
      background: var(--gray-100);
      overflow: hidden;
      height: 18px;
      border: 1px solid var(--gray-200);
      display: flex;
      position: relative;
    }

    .flow-part {
      height: 100%;
      font-size: 0.7rem;
      line-height: 18px;
      text-align: center;
      white-space: nowrap;
      overflow: hidden;
      text-overflow: ellipsis;
      color: #ffffff;
    }

    #flowBarHome {
      background: #3b82f6;
    }

    #flowBarAway {
      background: #22c55e;
    }

    .result-label {
      font-size: 0.78rem;
      margin: 4px 0;
    }

    .result-label strong {
      font-weight: 700;
    }

    .result-label span.value {
      font-weight: 700;
      color: var(--gray-900);
    }

    .winner-text {
      font-weight: 800;
      color: var(--green-dark);
    }

    .draw-text {
      font-weight: 700;
    }

    .draw-yes {
      color: var(--amber);
    }

    .draw-no {
      color: var(--red);
    }

    .history-note {
      font-size: 0.75rem;
      color: var(--gray-500);
      margin-top: 6px;
    }

    @media (max-width: 640px) {
      h1 {
        font-size: 1.4rem;
      }
      .card {
        padding: 12px 10px 16px;
      }
      th,
      td {
        padding: 5px 4px;
      }
      .table-scroll {
        max-height: 300px;
      }
    }
  </style>
</head>
<body>
<div class="page">
  <h1>Astro Football</h1>
  <div class="subtitle">Pure Panchapakshi Â· Football Only Â· Rule Lock ðŸ”’</div>

  <!-- STEP 1 -->
  <div class="card">
    <div class="section-title">Step 1 Â· Load Football Matches (API-Football)</div>
    <div class="section-sub">
      Enter your <strong>API-Football</strong> key. Only <strong>LIVE + UPCOMING</strong> matches
      are shown. Finished games are removed.
    </div>

    <div class="row" style="margin-bottom:10px;">
      <div class="col-2">
        <label for="apiKey">API key (dashboard.api-football.com)</label>
        <input id="apiKey" type="text" placeholder="Paste your API key here" />
      </div>
      <div class="col-2" style="max-width:150px;">
        <label for="matchDate">Day</label>
        <input id="matchDate" type="date" />
      </div>
    </div>

    <button id="loadMatchesBtn" class="btn btn-blue btn-block">Load Matches</button>
    <div id="apiMessage"></div>

    <div class="table-scroll" style="margin-top:10px;">
      <table>
        <thead>
        <tr>
          <th>Kickoff</th>
          <th>Home</th>
          <th>Away</th>
          <th>League</th>
          <th>Country</th>
        </tr>
        </thead>
        <tbody id="matchesBody"></tbody>
      </table>
    </div>
    <div class="helper-text">
      Tip: Tap a row above to send the match into Step 2.
    </div>
  </div>

  <!-- STEP 2 -->
  <div class="card">
    <div class="section-title">Step 2 Â· Match Input (From API Row or Manual)</div>

    <div class="row">
      <div class="col-2">
        <label for="homeTeam">Home team</label>
        <input id="homeTeam" type="text" placeholder="Home team name" />
      </div>
      <div class="col-2">
        <label for="awayTeam">Away team</label>
        <input id="awayTeam" type="text" placeholder="Away team name" />
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <div class="col-2">
        <label for="kickoffDate">Kickoff date (venue)</label>
        <input id="kickoffDate" type="date" />
      </div>
      <div class="col-2">
        <label for="kickoffTime">Kickoff time (venue)</label>
        <input id="kickoffTime" type="time" value="12:00" />
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <div class="col-2">
        <label for="venueTimezone">Venue timezone (from API)</label>
        <input id="venueTimezone" type="text" placeholder="Ex: UTC" />
      </div>
      <div class="col-2">
        <label for="league">League / competition</label>
        <input id="league" type="text" placeholder="Ex: Premier League" />
      </div>
    </div>

    <div class="row" style="margin-top:8px;">
      <div class="col-2">
        <label for="city">City / country</label>
        <input id="city" type="text" placeholder="Ex: Liverpool, England" />
      </div>
      <div class="col-2">
        <label for="paksha">Paksha (auto from date)</label>
        <select id="paksha">
          <option>Shukla</option>
          <option>Krishna</option>
        </select>
      </div>
    </div>

    <div style="margin-top:10px; display:flex; justify-content:space-between; align-items:center; flex-wrap:wrap; gap:8px;">
      <div>
        <span class="pill pill-blue">Day bird</span>
        <span style="margin-left:6px; font-size:0.85rem;" id="dayBirdLabel">â€“</span>
      </div>
      <button id="autoTeamBirdsBtn" class="btn btn-blue btn-small">
        Auto team birds from name (lock)
      </button>
    </div>

    <div style="margin-top:10px;">
      <div class="result-label">
        <strong>Team birds (locked):</strong>
        <span id="teamBirdSummary">â€“</span>
      </div>
    </div>
  </div>

  <!-- STEP 3 -->
  <div class="card">
    <div class="section-title">Step 3 Â· Pure Panchapakshi Prediction (Auto Lock)</div>

    <button id="runPredictionBtn" class="btn btn-block">Run Panchapakshi Prediction</button>

    <div style="margin-top:10px;">
      <div class="pill pill-blue">Team birds (lock)</div>
      <div class="result-label">
        <span id="homeBird">Home bird: â€“</span> Â·
        <span id="awayBird">Away bird: â€“</span>
      </div>
    </div>

    <div style="margin-top:6px;">
      <div class="pill pill-blue">Match Flow (Panchapakshi)</div>
      <div class="flow-wrapper">
        <div id="flowBarHome" class="flow-part" style="width:50%;">Home 50%</div>
        <div id="flowBarAway" class="flow-part" style="width:50%;">Away 50%</div>
      </div>
    </div>

    <div style="margin-top:10px;">
      <div class="result-label">
        <strong>Home activity:</strong> <span class="value" id="homeActivity">â€“</span> Â·
        <strong>Away activity:</strong> <span class="value" id="awayActivity">â€“</span>
      </div>

      <div class="result-label">
        <span class="pill pill-red">Draw?</span>
        <span class="draw-text" id="drawText" style="margin-left:6px;">â€“</span>
      </div>

      <div class="result-label">
        <span class="pill pill-amber">Correct score hint</span>
        <span id="scoreHint" style="margin-left:6px; font-size:0.78rem;">
          â€“ (Rule = 100 Â· Eat = 80 Â· Walk = 50 Â· Sleep = 30 Â· Die = 0)
        </span>
      </div>

      <div class="result-label">
        <span class="pill pill-green">Overall winner</span>
        <span id="overallWinner" style="margin-left:6px;">â€“</span>
      </div>

      <div class="result-label">
        <strong>Final call:</strong>
        <span class="winner-text" id="finalCall" style="margin-left:4px;">â€“</span>
      </div>
    </div>
  </div>

  <!-- SIMPLE LOCAL HISTORY (manual, optional) -->
  <div class="card">
    <div class="section-title">Prediction History (Local Device)</div>
    <div class="section-sub">
      Simple log stored only in this browser using localStorage.  
      After match finishes, you can add the final score to check Pass / Fail.
    </div>

    <button id="addHistoryBtn" class="btn btn-small btn-blue">Add current prediction to history</button>

    <div class="row" style="margin-top:8px;">
      <div class="col-2">
        <label for="finalScoreInput">Final score (Ex: 2-1 or 1-1)</label>
        <input id="finalScoreInput" type="text" placeholder="Enter final score & click update" />
      </div>
      <div class="col-2" style="align-self:flex-end;">
        <button id="updateHistoryBtn" class="btn btn-small btn-blue btn-block">Update last row (Pass/Fail)</button>
      </div>
    </div>

    <div class="table-scroll" style="margin-top:10px; max-height:260px;">
      <table>
        <thead>
        <tr>
          <th>Date</th>
          <th>Match</th>
          <th>Your call</th>
          <th>Final score</th>
          <th>Status</th>
        </tr>
        </thead>
        <tbody id="historyBody"></tbody>
      </table>
    </div>
    <div class="history-note">
      * Status: <span style="color:var(--green-dark); font-weight:600;">Pass</span> =
      winner or draw side correct; <span style="color:var(--red); font-weight:600;">Fail</span> = wrong call.
      You can clear browser data to reset list.
    </div>
  </div>
</div>

<script>
  // ---------- CONSTANTS ----------
  const API_BASE = 'https://v3.football.api-sports.io';
  // Only LIVE + UPCOMING statii (no finished)
  const STATUS_LIVE_UPCOMING = 'NS-1H-2H-ET-P';

  // Panchapakshi weights (LOCK ðŸ”’)
  const WEIGHTS = {
    rule: 100,
    eat: 80,
    walk: 50,
    sleep: 30,
    die: 0
  };

  const BIRDS = {
    vulture: { key: 'vulture', name: 'Vulture', icon: 'ðŸ¦…' },
    owl:     { key: 'owl',     name: 'Owl',     icon: 'ðŸ¦‰' },
    crow:    { key: 'crow',    name: 'Crow',    icon: 'ðŸ¦â€â¬›' },
    cock:    { key: 'cock',    name: 'Cock',    icon: 'ðŸ“' },
    peacock: { key: 'peacock', name: 'Peacock', icon: 'ðŸ¦š' }
  };

  const $ = (id) => document.getElementById(id);

  function showApiMessage(msg, isError = true) {
    const el = $('apiMessage');
    if (!el) return;
    el.textContent = msg;
    el.style.color = isError ? '#b91c1c' : '#166534';
  }

  // Nakshatra â†’ Bird (pure Panchapakshi)
  function getBirdFromNakshatra(nId, paksha) {
    const n = parseInt(nId, 10);
    let key = '';

    if (paksha === 'shukla') {
      if (n <= 5) key = 'vulture';
      else if (n <= 11) key = 'owl';
      else if (n <= 16) key = 'crow';
      else if (n <= 21) key = 'cock';
      else key = 'peacock';
    } else {
      if (n <= 5) key = 'peacock';
      else if (n <= 11) key = 'cock';
      else if (n <= 16) key = 'crow';
      else if (n <= 21) key = 'owl';
      else key = 'vulture';
    }
    return BIRDS[key];
  }

  // ---- NUMEROLOGY (Name â†’ number 1-27) ----
  const NUM_MAP = {
    A: 1, I: 1, J: 1, Q: 1, Y: 1,
    B: 2, K: 2, R: 2,
    C: 3, G: 3, L: 3, S: 3,
    D: 4, M: 4, T: 4,
    E: 5, H: 5, N: 5, X: 5,
    U: 6, V: 6, W: 6,
    O: 7, Z: 7,
    F: 8, P: 8
  };

  function nameToNumber(name) {
    let sum = 0;
    const up = (name || '').toUpperCase();
    for (const ch of up) {
      if (NUM_MAP[ch]) sum += NUM_MAP[ch];
    }
    while (sum > 27) {
      sum = sum.toString().split('').reduce((a, b) => a + Number(b), 0);
    }
    if (sum === 0) sum = 1;
    return sum;
  }

  function mapFixtureToRow(fix) {
    const d = fix.fixture.date;
    const dt = new Date(d);
    const timeStr = dt.toISOString().slice(11, 16); // HH:MM

    return {
      id: fix.fixture.id,
      kickoff: d,
      kickoffDisplay: timeStr + ' (' + fix.fixture.timezone + ')',
      home: fix.teams.home.name,
      away: fix.teams.away.name,
      league: fix.league.name,
      city: fix.league.country,
      status: fix.fixture.status.short // NS/1H/2H/FT...
    };
  }

  function renderMatchesTable(rows) {
    const tbody = $('matchesBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    if (!rows.length) {
      const tr = document.createElement('tr');
      const td = document.createElement('td');
      td.colSpan = 5;
      td.textContent = 'No live or upcoming matches for this day.';
      td.style.textAlign = 'center';
      tr.appendChild(td);
      tbody.appendChild(tr);
      return;
    }

    rows.forEach((row) => {
      const tr = document.createElement('tr');
      tr.className = 'match-row';
      tr.dataset.fixtureId = row.id;
      tr.dataset.home = row.home;
      tr.dataset.away = row.away;
      tr.dataset.kickoff = row.kickoff;
      tr.dataset.league = row.league;
      tr.dataset.city = row.city;
      tr.dataset.timezone = 'UTC';

      tr.innerHTML = `
        <td>${row.kickoffDisplay}</td>
        <td>${row.home}</td>
        <td>${row.away}</td>
        <td>${row.league}</td>
        <td>${row.city}</td>
      `;

      tr.addEventListener('click', () => sendMatchToStep2(tr));
      tbody.appendChild(tr);
    });
  }

  function sendMatchToStep2(rowEl) {
    $('homeTeam').value = rowEl.dataset.home;
    $('awayTeam').value = rowEl.dataset.away;

    const dt = new Date(rowEl.dataset.kickoff);
    $('kickoffDate').value = dt.toISOString().slice(0, 10);
    $('kickoffTime').value = dt.toISOString().slice(11, 16);

    $('venueTimezone').value = rowEl.dataset.timezone || 'UTC';
    $('league').value = rowEl.dataset.league;
    $('city').value = rowEl.dataset.city;

    const dayOfMonth = dt.getUTCDate();
    $('paksha').value = dayOfMonth <= 15 ? 'Shukla' : 'Krishna';

    autoTeamBirdsFromName();
  }

  async function loadMatches() {
    const apiKey = $('apiKey').value.trim();
    const dateStr = $('matchDate').value;

    if (!apiKey) {
      showApiMessage('Enter your API key.', true);
      return;
    }
    if (!dateStr) {
      showApiMessage('Select a date.', true);
      return;
    }

    showApiMessage('Loading matchesâ€¦', false);

    try {
      const url =
        `${API_BASE}/fixtures?date=${dateStr}` +
        `&status=${encodeURIComponent(STATUS_LIVE_UPCOMING)}` +
        `&timezone=UTC`;

      const res = await fetch(url, {
        headers: {
          'x-apisports-key': apiKey
        }
      });

      const data = await res.json();

      if (data.errors && Object.keys(data.errors).length) {
        showApiMessage('API error: ' + JSON.stringify(data.errors), true);
        renderMatchesTable([]);
        return;
      }

      if (!data.response) {
        showApiMessage('API error: empty response.', true);
        renderMatchesTable([]);
        return;
      }

      const rows = data.response.map(mapFixtureToRow);
      renderMatchesTable(rows);
      showApiMessage('API call success. Click a row to send into Step 2.', false);
    } catch (err) {
      console.error(err);
      showApiMessage('Network / API error. Check internet + key / quota.', true);
      renderMatchesTable([]);
    }
  }

  function autoTeamBirdsFromName() {
    const homeName = $('homeTeam').value.trim();
    const awayName = $('awayTeam').value.trim();
    if (!homeName || !awayName) return;

    const pakshaVal = $('paksha').value.toLowerCase();
    const pakshaKey = pakshaVal === 'krishna' ? 'krishna' : 'shukla';

    const homeNak = nameToNumber(homeName);
    const awayNak = nameToNumber(awayName);

    const homeBirdObj = getBirdFromNakshatra(homeNak, pakshaKey);
    const awayBirdObj = getBirdFromNakshatra(awayNak, pakshaKey);

    $('homeBird').textContent = `${homeName} â†’ ${homeBirdObj.name} ${homeBirdObj.icon}`;
    $('awayBird').textContent = `${awayName} â†’ ${awayBirdObj.name} ${awayBirdObj.icon}`;
    $('teamBirdSummary').textContent =
      `${homeName} â†’ ${homeBirdObj.name} Â· ${awayName} â†’ ${awayBirdObj.name}`;

    $('homeBird').dataset.birdKey = homeBirdObj.key;
    $('awayBird').dataset.birdKey = awayBirdObj.key;
  }

  function runPanchapakshiPrediction() {
    const homeKey = $('homeBird').dataset.birdKey;
    const awayKey = $('awayBird').dataset.birdKey;
    if (!homeKey || !awayKey) {
      alert('First click AUTO TEAM BIRDS FROM NAME (LOCK).');
      return;
    }

    const pakshaVal = $('paksha').value.toLowerCase();
    const pakshaKey = pakshaVal === 'krishna' ? 'krishna' : 'shukla';

    const dateStr = $('kickoffDate').value;
    if (!dateStr) {
      alert('Kickoff date missing.');
      return;
    }

    const d = new Date(dateStr + 'T00:00:00Z');
    const wd = d.getUTCDay();        // 0..6
    const dayNakId = (wd * 4) + 1;   // simple, stable mapping

    const dayBird = getBirdFromNakshatra(dayNakId, pakshaKey);
    $('dayBirdLabel').textContent = `${dayBird.name} ${dayBird.icon}`;

    function birdScore(teamKey) {
      if (teamKey === dayBird.key) return WEIGHTS.rule;

      if (
        (teamKey === 'vulture' && dayBird.key === 'crow') ||
        (teamKey === 'crow' && dayBird.key === 'vulture') ||
        (teamKey === 'owl' && dayBird.key === 'cock') ||
        (teamKey === 'cock' && dayBird.key === 'owl')
      ) {
        return WEIGHTS.die;
      }

      return WEIGHTS.walk;
    }

    const homeScore = birdScore(homeKey);
    const awayScore = birdScore(awayKey);
    const total = homeScore + awayScore || 1;

    const homePct = Math.round((homeScore / total) * 100);
    const awayPct = 100 - homePct;

    $('flowBarHome').style.width = homePct + '%';
    $('flowBarAway').style.width = awayPct + '%';
    $('flowBarHome').textContent = `${$('homeTeam').value} ${homePct}%`;
    $('flowBarAway').textContent = `${$('awayTeam').value} ${awayPct}%`;

    $('homeActivity').textContent = homeScore === WEIGHTS.rule
      ? 'Rule'
      : (homeScore === WEIGHTS.walk ? 'Walk' : (homeScore === WEIGHTS.die ? 'Die' : 'Eat/ Sleep'));
    $('awayActivity').textContent = awayScore === WEIGHTS.rule
      ? 'Rule'
      : (awayScore === WEIGHTS.walk ? 'Walk' : (awayScore === WEIGHTS.die ? 'Die' : 'Eat/ Sleep'));

    const diff = Math.abs(homePct - awayPct);
    const isDrawZone = diff <= 10;

    $('drawText').textContent = isDrawZone
      ? 'YES â€“ energies nearly equal.'
      : 'NO â€“ one bird clearly stronger.';
    $('drawText').classList.toggle('draw-yes', isDrawZone);
    $('drawText').classList.toggle('draw-no', !isDrawZone);

    let scoreHint;
    if (isDrawZone) {
      scoreHint = 'Likely draw: 0â€“0 or 1â€“1.';
    } else if (homePct > awayPct) {
      scoreHint = 'Home win: 1â€“0 or 2â€“1.';
    } else {
      scoreHint = 'Away win: 0â€“1 or 1â€“2.';
    }
    $('scoreHint').textContent =
      `${scoreHint}  Rule = ${WEIGHTS.rule} Â· Eat = ${WEIGHTS.eat} Â· Walk = ${WEIGHTS.walk} Â· Sleep = ${WEIGHTS.sleep} Â· Die = ${WEIGHTS.die} (engine lock).`;

    const homeName = $('homeTeam').value;
    const awayName = $('awayTeam').value;

    let finalWinnerText = 'Balanced / 50-50';
    if (!isDrawZone) {
      finalWinnerText = homePct > awayPct ? homeName : awayName;
    }

    $('overallWinner').textContent = `${homeName} ${homePct}% Â· ${awayName} ${awayPct}%`;
    $('finalCall').textContent = finalWinnerText;

    lastPrediction = {
      date: dateStr,
      match: `${homeName} vs ${awayName}`,
      call: isDrawZone ? 'Draw' : finalWinnerText,
      finalScore: '',
      status: 'Pending'
    };
    renderHistory(); // refresh view
  }

  // ------- SIMPLE HISTORY (LOCALSTORAGE) -------
  let history = [];
  let lastPrediction = null;

  function loadHistory() {
    try {
      const raw = localStorage.getItem('astro-football-history');
      if (raw) history = JSON.parse(raw);
    } catch (e) {
      history = [];
    }
    renderHistory();
  }

  function saveHistory() {
    try {
      localStorage.setItem('astro-football-history', JSON.stringify(history));
    } catch (e) { /* ignore */ }
  }

  function renderHistory() {
    const tbody = $('historyBody');
    if (!tbody) return;
    tbody.innerHTML = '';

    const all = [...history];
    if (lastPrediction && !history.length) {
      all.push(lastPrediction);
    }

    all.forEach((row, idx) => {
      const tr = document.createElement('tr');
      tr.innerHTML = `
        <td>${row.date || '-'}</td>
        <td>${row.match || '-'}</td>
        <td>${row.call || '-'}</td>
        <td>${row.finalScore || '-'}</td>
        <td style="font-weight:700; color:${
          row.status === 'Pass' ? '#15803d' :
            row.status === 'Fail' ? '#b91c1c' : '#6b7280'
        }">${row.status || 'Pending'}</td>
      `;
      tbody.appendChild(tr);
    });
  }

  function addHistoryFromLast() {
    if (!lastPrediction) {
      alert('Run a prediction first.');
      return;
    }
    history.push({ ...lastPrediction });
    lastPrediction = null;
    saveHistory();
    renderHistory();
  }

  function updateLastHistory() {
    const score = $('finalScoreInput').value.trim();
    if (!score) {
      alert('Enter final score, ex: 2-1');
      return;
    }
    if (!history.length) {
      alert('Add a prediction to history first.');
      return;
    }
    const last = history[history.length - 1];
    last.finalScore = score;

    const call = (last.call || '').toLowerCase();
    let status = 'Neutral';

    if (call === 'draw' && score.includes('1-1') || score.includes('0-0') || score.includes('2-2')) {
      status = 'Pass';
    } else if (call !== 'draw') {
      const [h, a] = score.split(/[-:]/).map((s) => parseInt(s.trim(), 10));
      if (!isNaN(h) && !isNaN(a)) {
        const winner = h > a ? 'home' : (a > h ? 'away' : 'draw');
        if (winner === 'draw' && call === 'draw') status = 'Pass';
        else if (winner === 'home' && call === last.match.split(' vs ')[0]) status = 'Pass';
        else if (winner === 'away' && call === last.match.split(' vs ')[1]) status = 'Pass';
        else status = 'Fail';
      }
    }

    last.status = status;
    saveHistory();
    renderHistory();
  }

  // ------- INIT -------
  window.addEventListener('DOMContentLoaded', () => {
    const today = new Date();
    const isoDate = today.toISOString().slice(0, 10);
    if ($('matchDate')) $('matchDate').value = isoDate;
    if ($('kickoffDate')) $('kickoffDate').value = isoDate;

    $('loadMatchesBtn').addEventListener('click', loadMatches);
    $('autoTeamBirdsBtn').addEventListener('click', autoTeamBirdsFromName);
    $('runPredictionBtn').addEventListener('click', runPanchapakshiPrediction);
    $('addHistoryBtn').addEventListener('click', addHistoryFromLast);
    $('updateHistoryBtn').addEventListener('click', updateLastHistory);

    loadHistory();
  });
</script>
</body>
</html>
