<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Astro Football â€¢ Pure Panchapakshi</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <style>
    :root{
      --home-main:#0ea5e9;
      --away-main:#22c55e;
    }

    *{box-sizing:border-box;}

    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#ffffff;
      color:#111827;
    }
    .wrap{
      max-width:960px;
      margin:0 auto;
      padding:14px;
    }
    h1{
      font-size:18px;
      text-transform:uppercase;
      letter-spacing:0.28em;
      color:#111827;
      text-align:center;
      margin:6px 0 2px;
    }
    .subtitle{
      text-align:center;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.22em;
      color:#6b7280;
      margin-bottom:12px;
    }

    .card{
      background:#f9fafb;
      border:1px solid #e5e7eb;
      border-radius:16px;
      padding:12px;
      margin-bottom:14px;
      box-shadow:0 10px 25px rgba(15,23,42,0.06);
    }

    .title-sm{
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.22em;
      color:#6b7280;
      margin-bottom:8px;
    }

    label{
      display:block;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.18em;
      color:#9ca3af;
      margin-bottom:3px;
    }
    input,select{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #d1d5db;
      background:#ffffff;
      color:#111827;
      font-size:13px;
      margin-bottom:10px;
    }
    input:focus,select:focus{
      outline:none;
      border-color:#0ea5e9;
      box-shadow:0 0 0 1px #0ea5e9;
    }

    .row{
      display:flex;
      gap:10px;
      flex-wrap:wrap;
    }
    .row>div{
      flex:1;
      min-width:140px;
    }

    button{
      width:100%;
      padding:9px;
      border:none;
      border-radius:999px;
      text-transform:uppercase;
      letter-spacing:0.18em;
      font-size:11px;
      font-weight:600;
      color:#ffffff;
      cursor:pointer;
      margin-bottom:4px;
    }
    .btn-main{
      background:linear-gradient(90deg,#2563eb,#22c55e);
      box-shadow:0 8px 18px rgba(37,99,235,0.35);
    }
    .btn-dark{
      background:linear-gradient(90deg,#111827,#4b5563);
      box-shadow:0 8px 18px rgba(17,24,39,0.35);
    }
    .btn-ghost{
      background:#e5e7eb;
      color:#111827;
      box-shadow:none;
    }
    button:active{transform:scale(.97);}

    .tiny{
      font-size:11px;
      color:#6b7280;
      margin-top:4px;
      line-height:1.6;
    }

    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
      margin-top:4px;
    }
    th,td{
      border:1px solid #e5e7eb;
      padding:4px 6px;
      text-align:left;
      white-space:nowrap;
    }
    th{
      background:#e5f3ff;
      color:#374151;
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-size:10px;
    }
    tr:nth-child(even){background:#ffffff;}
    tr:nth-child(odd){background:#f9fafb;}
    tr:hover{background:#e0f2fe;cursor:pointer;}

    .status-live{
      color:#dc2626;
      font-weight:600;
      display:flex;
      align-items:center;
      gap:4px;
    }
    .live-dot{
      width:8px;
      height:8px;
      border-radius:50%;
      background:#ef4444;
      box-shadow:0 0 0 3px rgba(248,113,113,0.4);
    }

    .tag{
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.12em;
      font-size:10px;
      padding:2px 8px;
      border-radius:999px;
      display:inline-block;
      margin-right:6px;
    }
    .tag-day{background:#dbeafe;color:#1d4ed8;}
    .tag-flow{background:#e0f2fe;color:#075985;}
    .tag-overall{background:#fee2a7;color:#92400e;}

    .home-text{color:var(--home-main);font-weight:600;}
    .away-text{color:var(--away-main);font-weight:600;}
    .good-text{color:#22c55e;font-weight:600;}
    .weak-text{color:#ef4444;font-weight:600;}
    .excellent-text{color:#15803d;font-weight:700;}

    .bar-wrap{
      width:100%;
      height:14px;
      border-radius:999px;
      overflow:hidden;
      background:#e5e7eb;
      border:1px solid #d1d5db;
      margin:6px 0 4px 0;
      display:flex;
      position:relative;
    }
    .bar-fill{height:100%;}
    .bar-home{background:linear-gradient(90deg,var(--home-main),#38bdf8);}
    .bar-away{background:linear-gradient(90deg,var(--away-main),#22c55e);}
    .bar-label{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      font-size:10px;
      font-weight:600;
      white-space:nowrap;
      color:#ffffff;
      text-shadow:0 1px 2px rgba(0,0,0,0.6);
    }
    .bar-label span{color:#ffffff !important;}

    .summary-line{
      font-size:11.5px;
      margin:1px 0;
    }

    @media (max-width:600px){
      th:nth-child(4),td:nth-child(4){display:none;} /* hide league col on small */
      th:nth-child(6),td:nth-child(6){display:none;} /* hide status text */
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>ASTRO FOOTBALL</h1>
  <div class="subtitle">Pure Panchapakshi Â· Football Only Â· Rule Lock ðŸ”’</div>

  <!-- STEP 1 â€“ API FOOTBALL -->
  <div class="card">
    <div class="title-sm">Step 1 Â· Load Football Matches (API-Football)</div>
    <div class="row">
      <div>
        <label>API key (api-football.com)</label>
        <input id="apiKey" placeholder="Paste your API key" />
      </div>
      <div>
        <label>Matches</label>
        <select id="matchFilter">
          <option value="today">Today Â· Live &amp; Upcoming</option>
        </select>
      </div>
      <div style="flex:0 0 130px;align-self:flex-end;">
        <button id="btnLoad" class="btn-main">Load</button>
      </div>
    </div>
    <div id="apiInfo" class="tiny">
      INFO Â· Key is used only in your browser. Shows today <b>LIVE</b> (red dot) + upcoming fixtures.
      Finished matches are removed. Click a row below to send the match into Step 2.
    </div>

    <div style="margin-top:8px;max-height:320px;overflow:auto;border-radius:12px;border:1px solid #e5e7eb;">
      <table>
        <thead>
          <tr>
            <th>Kickoff</th>
            <th>Home</th>
            <th>Away</th>
            <th>League</th>
            <th>City</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="matchesBody">
          <!-- rows added by JS -->
        </tbody>
      </table>
    </div>
  </div>

  <!-- STEP 2 â€“ MATCH INPUT -->
  <div class="card">
    <div class="title-sm">Step 2 Â· Match Input (from API or manual)</div>

    <div class="row">
      <div>
        <label>Home team</label>
        <input id="homeTeam" placeholder="Home team name">
      </div>
      <div>
        <label>Away team</label>
        <input id="awayTeam" placeholder="Away team name">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Kickoff date (venue)</label>
        <input id="kickoffDate" type="date">
      </div>
      <div>
        <label>Kickoff time (venue)</label>
        <input id="kickoffTime" type="time" value="20:00">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Venue timezone (from API)</label>
        <input id="venueTz" placeholder="Ex: Europe/London">
      </div>
      <div>
        <label>League / competition</label>
        <input id="league" placeholder="Ex: Premier League">
      </div>
      <div>
        <label>City / country</label>
        <input id="city" placeholder="Ex: Liverpool, England">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Paksha (auto from date)</label>
        <select id="paksha" disabled>
          <option value="shukla">Shukla</option>
          <option value="krishna">Krishna</option>
        </select>
      </div>
      <div style="flex:1.3;align-self:flex-end;">
        <button id="btnAutoBirds" class="btn-dark">
          Auto team birds from name (LOCK)
        </button>
      </div>
    </div>

    <div class="tiny" id="lockInfo">
      Paksha &amp; team birds will be locked automatically from match date + team name
      (numerology â†’ 27 nakshatra â†’ bird). Rule lock = pure Panchapakshi prediction only.
    </div>

    <div class="tiny" id="dayInfo" style="margin-top:6px;"></div>
    <div class="tiny" id="teamBirdInfo" style="margin-top:2px;"></div>
  </div>

  <!-- STEP 3 â€“ RESULT -->
  <div class="card">
    <div class="title-sm">Step 3 Â· Pure Panchapakshi Prediction (Auto Lock)</div>
    <button id="btnPredict" class="btn-main">
      Run Panchapakshi Prediction
    </button>
    <div class="tiny" id="waitingLine">Waiting for match inputâ€¦</div>
    <div id="summaryBox" style="margin-top:8px;font-size:11.5px;"></div>
  </div>
</div>

<script>
/* ----------- SMALL HELPERS ----------- */
const $ = id => document.getElementById(id);
function fmtTime(dateStr){
  const d = new Date(dateStr);
  if(isNaN(d)) return '';
  return d.toLocaleTimeString([], {hour:'2-digit',minute:'2-digit'});
}
function fmtDate(dateStr){
  const d = new Date(dateStr);
  if(isNaN(d)) return '';
  const y=d.getFullYear();
  const m=String(d.getMonth()+1).padStart(2,'0');
  const day=String(d.getDate()).padStart(2,'0');
  return `${y}-${m}-${day}`;
}

/* ----------- PANCHAPAKSHI TABLES ----------- */
const BIRDS = ['Vulture','Owl','Crow','Cock','Peacock'];

const BIRD_PLANETS = {
  shukla: {
    Vulture:['Jupiter','Saturn'],
    Owl:['Sun','Venus'],
    Crow:['Moon'],
    Cock:['Mars'],
    Peacock:['Mercury']
  },
  krishna: {
    Vulture:['Mars'],
    Owl:['Moon'],
    Crow:['Sun'],
    Cock:['Jupiter','Saturn'],
    Peacock:['Mercury','Venus']
  }
};

const DAY_PLANETS = ['Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn'];

function deriveRulingBirds(paksha){
  const map=BIRD_PLANETS[paksha];
  const arr=[];
  for(let d=0;d<7;d++){
    const planet=DAY_PLANETS[d];
    let chosen='Vulture';
    for(const bird of BIRDS){
      const list=map[bird]||[];
      if(list.includes(planet)){chosen=bird;break;}
    }
    arr.push(chosen);
  }
  return arr;
}
const RULING_BIRDS = {
  shukla: deriveRulingBirds('shukla'),
  krishna: deriveRulingBirds('krishna')
};

const FRIENDLY_BIRDS = {
  Vulture:['Owl','Cock'],
  Owl:['Vulture','Peacock'],
  Crow:['Peacock','Cock'],
  Cock:['Vulture','Crow'],
  Peacock:['Owl','Crow']
};
const UNFRIENDLY_BIRDS = {
  Vulture:['Peacock','Crow'],
  Owl:['Crow','Cock'],
  Crow:['Vulture','Owl'],
  Cock:['Peacock','Owl'],
  Peacock:['Vulture','Cock']
};

/* 27 nakshatra â†’ bird mapping (1-27) */
const NAK_BIRD = [
  'Peacock','Peacock','Peacock','Peacock','Peacock', // 1-5
  'Cock','Cock','Cock','Cock','Cock','Cock',        // 6-11
  'Crow','Crow','Crow','Crow','Crow',               // 12-16
  'Owl','Owl','Owl','Owl','Owl',                    // 17-21
  'Vulture','Vulture','Vulture','Vulture','Vulture','Vulture' // 22-27
];

/* Activity strengths for football */
const ACTIVITY_SCORE = {
  Rule:100,
  Eat:80,
  Walk:50,
  Sleep:30,
  Die:0
};
const APAHARA_DUR = {Rule:48,Eat:30,Walk:36,Sleep:18,Die:12};
const ACTIVITY_CYCLES = {
  shukla_day:['Eat','Walk','Rule','Sleep','Die'],
  shukla_night:['Eat','Rule','Die','Walk','Sleep'],
  krishna_day:['Eat','Die','Sleep','Rule','Walk'],
  krishna_night:['Eat','Sleep','Walk','Die','Rule']
};

/* ----------- PAKSHA AUTO FROM DATE (MOON AGE) ----------- */
function computeMoonAge(date){
  const year=date.getUTCFullYear();
  const month=date.getUTCMonth()+1;
  const day=date.getUTCDate();
  let yy=year-Math.floor((12-month)/10);
  let mm=month+9;
  if(mm>=12)mm-=12;
  const k1=Math.floor(365.25*(yy+4712));
  const k2=Math.floor(30.6*mm+0.5);
  const k3=Math.floor(Math.floor((yy/100)+49)*0.75)-38;
  const jd=k1+k2+day+59-k3;
  const ip=(jd-2451550.1)/29.530588853;
  const frac=ip-Math.floor(ip);
  return frac*29.530588853;
}
function autoPakshaFromDate(iso){
  const d=new Date(iso);
  if(isNaN(d)) return 'shukla';
  const age=computeMoonAge(d);
  return (age<14.765)?'shukla':'krishna';
}

/* ----------- TIME / SEGMENTS ----------- */
function timeToMins(t){
  if(!t) return 0;
  const [h,m]=t.split(':').map(Number);
  return h*60+m;
}
function minsToTime(m){
  let x=m;
  while(x<0)x+=1440;
  x=x%1440;
  const h=Math.floor(x/60);
  const mm=x%60;
  return h.toString().padStart(2,'0')+":"+mm.toString().padStart(2,'0');
}

/* main yama context */
function getMainYamaContext(bird,timeMins,dayIdx,pakshaType){
  const dayStart=360;   // 6:00
  const nightStart=1080;// 18:00
  const yamaDur=144;    // 2h24m
  let isNight=false,minsSince=0,cycleStart=dayStart;
  let t=timeMins;
  if(t<dayStart)t+=1440;
  if(t>=dayStart && t<nightStart){
    isNight=false;
    minsSince=t-dayStart;
    cycleStart=dayStart;
  }else{
    isNight=true;
    if(t>=nightStart){
      minsSince=t-nightStart;
      cycleStart=nightStart;
    }else{
      minsSince=(t+1440)-nightStart;
      cycleStart=nightStart;
    }
  }
  const yamaIndex=Math.floor(minsSince/yamaDur);
  const clamped=Math.min(yamaIndex,4);
  const key=pakshaType+'_'+(isNight?'night':'day');
  const cycle=ACTIVITY_CYCLES[key];
  const ruling=RULING_BIRDS[pakshaType][dayIdx];
  const bi=BIRDS.indexOf(bird);
  const ri=BIRDS.indexOf(ruling);
  const dist=(bi-ri+5)%5;
  const actIdx=(clamped+dist)%5;
  const mainAct=cycle[actIdx];
  const yamaStart=cycleStart+(clamped*yamaDur);
  return {mainAct,yamaStart,cycle};
}

/* generate detailed segments for a time range */
function generateSegments(bird,startMins,endMins,dayIdx,pakshaType){
  let segments=[];
  let cur=startMins;
  while(cur<endMins){
    const {mainAct,yamaStart,cycle}=getMainYamaContext(bird,cur%1440,dayIdx,pakshaType);
    const mainIdx=cycle.indexOf(mainAct);
    let subStart=yamaStart;
    let subSegs=[];
    for(let i=0;i<5;i++){
      const name=cycle[(mainIdx+i)%5];
      const dur=APAHARA_DUR[name];
      subSegs.push({
        activity:name,
        start:subStart,
        end:subStart+dur,
        score:ACTIVITY_SCORE[name]
      });
      subStart+=dur;
    }
    for(const s of subSegs){
      const effStart=Math.max(cur,s.start);
      const effEnd=Math.min(endMins,s.end);
      if(effEnd>effStart){
        segments.push({
          startMins:effStart,
          endMins:effEnd,
          activity:s.activity,
          score:s.score,
          duration:effEnd-effStart
        });
        cur=effEnd;
      }
    }
    if(cur>=endMins)break;
    if(cur<yamaStart+144)cur=yamaStart+144;
  }
  return segments;
}

/* average environment percentage for match */
function calcEnvPercent(homeBird,awayBird,dateIso,kickoffTime,pakshaType){
  const d=new Date(dateIso);
  if(isNaN(d)) return {home:50,away:50};
  const dayIdx=d.getDay();
  const startMins=timeToMins(kickoffTime||"20:00");
  const endMins=startMins+120; // 2 hours

  const segHome=generateSegments(homeBird,startMins,endMins,dayIdx,pakshaType);
  const segAway=generateSegments(awayBird,startMins,endMins,dayIdx,pakshaType);

  let points=new Set([startMins,endMins]);
  segHome.forEach(s=>{points.add(s.startMins);points.add(s.endMins);});
  segAway.forEach(s=>{points.add(s.startMins);points.add(s.endMins);});
  const sorted=[...points].sort((a,b)=>a-b);

  let totDur=0, accHome=0;
  for(let i=0;i<sorted.length-1;i++){
    const a=sorted[i],b=sorted[i+1],dur=b-a;
    const h=segHome.find(s=>s.startMins<=a && s.endMins>=b);
    const aw=segAway.find(s=>s.startMins<=a && s.endMins>=b);
    if(h&&aw){
      const totalScore=h.score+aw.score;
      const homePct=totalScore>0?(h.score/totalScore)*100:50;
      accHome+=homePct*dur;
      totDur+=dur;
    }
  }
  if(!totDur) return {home:50,away:50};
  const home=accHome/totDur;
  const away=100-home;
  return {home,away};
}

/* ----------- NUMEROLOGY â†’ 27 NAK â†’ BIRD ----------- */
function nameToNakshatraIndex(name){
  if(!name) return 0;
  const clean=name.toUpperCase().replace(/[^A-Z]/g,'');
  if(!clean) return 0;
  let sum=0;
  for(const ch of clean){
    const n = (ch.charCodeAt(0)-64); // A=1 .. Z=26
    sum += ((n-1)%9)+1;             // reduce 1-9
  }
  const idx = (sum-1)%27; // 0-26
  return idx;
}
function teamNameToBird(name){
  const idx=nameToNakshatraIndex(name);
  if(idx<0) return 'Vulture';
  return NAK_BIRD[idx] || 'Vulture';
}

/* ----------- UI: AUTO PAKSHA + DAY BIRD LINE ----------- */
function updateDayInfo(){
  const dateIso=$('kickoffDate').value;
  if(!dateIso){
    $('dayInfo').innerHTML = 'Day bird: set match date to view.';
    return;
  }
  const paksha=$('paksha').value;
  const d=new Date(dateIso);
  const dayIdx=d.getDay();
  const rulingBird=RULING_BIRDS[paksha][dayIdx];
  const friendly=FRIENDLY_BIRDS[rulingBird]||[];
  const enemy=UNFRIENDLY_BIRDS[rulingBird]||[];
  const dayNames=['Sunday','Monday','Tuesday','Wednesday','Thursday','Friday','Saturday'];

  $('dayInfo').innerHTML =
    `<span class="tag tag-day">Day Bird</span>`+
    `${dayNames[dayIdx]} Â· Paksha: ${paksha==='shukla'?'Shukla':'Krishna'} Â· `+
    `Ruling bird: <span class="excellent-text">${rulingBird}</span> Â· `+
    `Friendly: <span class="good-text">${friendly.join(', ')||'-'}</span> Â· `+
    `Enemy: <span class="weak-text">${enemy.join(', ')||'-'}</span>`;
}

/* ----------- UI: AUTO TEAM BIRDS ----------- */
let lockedHomeBird=null;
let lockedAwayBird=null;

function autoTeamBirds(){
  const home=$('homeTeam').value.trim();
  const away=$('awayTeam').value.trim();
  if(!home || !away){
    alert('Enter both home & away team names first.');
    return;
  }
  lockedHomeBird = teamNameToBird(home);
  lockedAwayBird = teamNameToBird(away);

  $('teamBirdInfo').innerHTML =
    `Auto team birds (locked): `+
    `<span class="home-text">Home â†’ ${lockedHomeBird}</span> Â· `+
    `<span class="away-text">Away â†’ ${lockedAwayBird}</span><br>`+
    `<span style="font-size:10px;">(From team name â†’ numerology â†’ 27 nakshatra â†’ bird. Locked for prediction.)</span>`;
}

/* ----------- PREDICTION + SUMMARY ----------- */
function makeBar(pHome,pAway,homeLabel,awayLabel){
  return `
    <div class="bar-wrap">
      <div class="bar-fill bar-home" style="width:${pHome}%;"></div>
      <div class="bar-fill bar-away" style="width:${pAway}%;"></div>
      <div class="bar-label">
        <span class="home-text">${homeLabel}</span> â€¢
        <span class="away-text">${awayLabel}</span>
      </div>
    </div>`;
}

function runPrediction(){
  const home=$('homeTeam').value.trim()||'Home';
  const away=$('awayTeam').value.trim()||'Away';
  const dateIso=$('kickoffDate').value;
  const time=$('kickoffTime').value||'20:00';
  const paksha=$('paksha').value;

  if(!dateIso){
    alert('Set kickoff date first.');
    return;
  }
  if(!lockedHomeBird || !lockedAwayBird){
    autoTeamBirds(); // auto-lock if user forgot
  }

  const env=calcEnvPercent(lockedHomeBird,lockedAwayBird,dateIso,time,paksha);
  const envHome=env.home;
  const envAway=env.away;

  const diff=envHome-envAway;

  // Draw check
  const drawLikely = Math.abs(diff)<=8;
  const drawText = drawLikely
    ? 'YES â€“ birds & activities nearly balanced.'
    : 'NO â€“ one side has clear bird-energy advantage.';

  // Winner
  let overallWinner='Balanced / 50-50';
  if(diff>2) overallWinner=home;
  else if(diff<-2) overallWinner=away;

  // Correct score suggestion (simple)
  let scoreSuggestion='';
  if(drawLikely){
    scoreSuggestion = '1-1 or 2-2 (draw side strong).';
  }else if(diff>8){
    scoreSuggestion = 'Home win: 2-0 or 3-1.';
  }else if(diff>2){
    scoreSuggestion = 'Home edge: 1-0 or 2-1.';
  }else if(diff<-8){
    scoreSuggestion = 'Away win: 0-2 or 1-3.';
  }else if(diff<-2){
    scoreSuggestion = 'Away edge: 0-1 or 1-2.';
  }

  const envBar = makeBar(
    envHome,
    envAway,
    `${home} ${envHome.toFixed(1)}%`,
    `${away} ${envAway.toFixed(1)}%`
  );

  const overallClassHome = overallWinner===home ? 'excellent-text' : (overallWinner===away ? 'weak-text' : 'home-text');
  const overallClassAway = overallWinner===away ? 'excellent-text' : (overallWinner===home ? 'weak-text' : 'away-text');

  $('waitingLine').style.display='none';

  $('summaryBox').innerHTML =
    `<div class="summary-line">
       <span class="tag tag-flow">Team Birds</span>
       <span class="home-text">${home}</span> bird: <b>${lockedHomeBird}</b> Â·
       <span class="away-text">${away}</span> bird: <b>${lockedAwayBird}</b>
     </div>
     <div class="summary-line">
       <span class="tag tag-flow">Match Flow</span>
       ${envBar}
     </div>
     <div class="summary-line">
       Draw chance: <b>${drawText}</b>
     </div>
     <div class="summary-line">
       Correct score (from activity Rule 100 Â· Eat 80 Â· Walk 50 Â· Sleep 30 Â· Die 0):
       <b>${scoreSuggestion || 'No strong score pattern (use match flow %).'}
       </b>
     </div>
     <div class="summary-line">
       <span class="tag tag-overall">Overall Winner</span>
       <span class="${overallClassHome}">${home}</span> ${envHome.toFixed(1)}% Â·
       <span class="${overallClassAway}">${away}</span> ${envAway.toFixed(1)}%<br>
       Final call: <span class="excellent-text">${overallWinner}</span>
     </div>`;
}

/* ----------- API â€“ LOAD MATCHES (NO live=all) ----------- */
async function loadMatches(){
  const key=$('apiKey').value.trim();
  if(!key){
    alert('Paste your API key from api-football.com first.');
    return;
  }
  $('matchesBody').innerHTML='';
  $('apiInfo').style.color='#6b7280';
  $('apiInfo').textContent='Loading matchesâ€¦';

  try{
    const today=new Date();
    const dateStr=today.toISOString().slice(0,10); // YYYY-MM-DD
    // IMPORTANT: no live=all here (this was causing error)
    const url=`https://v3.football.api-sports.io/fixtures?date=${dateStr}&timezone=UTC`;

    const res=await fetch(url,{
      headers:{
        'x-apisports-key':key
      }
    });
    if(!res.ok){
      throw new Error('HTTP '+res.status);
    }
    const data=await res.json();
    const list=data.response||[];

    const finishedCodes=['FT','AET','PEN','CANC','ABD','AWD','WO','PST'];
    const liveCodes=['1H','2H','ET','BT','LIVE','P'];
    const tbody=$('matchesBody');

    list.forEach(item=>{
      const fx=item.fixture;
      const st=fx.status?.short || '';
      if(finishedCodes.includes(st)) return; // remove finished

      const home=item.teams?.home?.name || 'Home';
      const away=item.teams?.away?.name || 'Away';
      const league=item.league?.name || '';
      const city=fx.venue?.city || '';
      const country=fx.venue?.country || '';
      const kickoffISO=fx.date;
      const koDate=fmtDate(kickoffISO);
      const koTime=fmtTime(kickoffISO);
      const tz=fx.timezone || 'UTC';

      const tr=document.createElement('tr');
      const isLive=liveCodes.includes(st);

      tr.innerHTML=
        `<td>${koDate} ${koTime}</td>
         <td>${home}</td>
         <td>${away}</td>
         <td>${league}</td>
         <td>${city || country}</td>
         <td>${isLive
             ? '<span class="status-live"><span class="live-dot"></span>LIVE</span>'
             : (st || 'NS')}</td>`;

      tr.addEventListener('click',()=>{
        $('homeTeam').value=home;
        $('awayTeam').value=away;
        $('kickoffDate').value=koDate;
        $('kickoffTime').value=koTime.slice(0,5);
        $('venueTz').value=tz;
        $('league').value=league;
        $('city').value=city || country;

        // paksha auto from date
        const p=autoPakshaFromDate(koDate);
        $('paksha').value=p;
        updateDayInfo();
        autoTeamBirds(); // lock birds from team name
      });

      tbody.appendChild(tr);
    });

    if(!tbody.children.length){
      $('matchesBody').innerHTML =
        `<tr><td colspan="6">No live/upcoming fixtures found for today (or quota exceeded).</td></tr>`;
    }
    $('apiInfo').style.color='#6b7280';
    $('apiInfo').textContent=
      'Click a row to send the match into Step 2. Red dot = live match. Finished matches are hidden.';
  }catch(err){
    console.error(err);
    $('apiInfo').style.color='#dc2626';
    $('apiInfo').textContent=
      'Network / API error. Check internet + key + quota. (Open browser console for details.)';
    alert('Network / API error. Check internet + key / quota.');
  }
}

/* ----------- INIT ----------- */
(function init(){
  const today=new Date().toISOString().slice(0,10);
  $('kickoffDate').value=today;
  const p=autoPakshaFromDate(today);
  $('paksha').value=p;
  updateDayInfo();

  $('kickoffDate').addEventListener('change',()=>{
    const p2=autoPakshaFromDate($('kickoffDate').value);
    $('paksha').value=p2;
    updateDayInfo();
  });

  $('btnLoad').addEventListener('click',loadMatches);
  $('btnAutoBirds').addEventListener('click',(e)=>{e.preventDefault();autoTeamBirds();});
  $('btnPredict').addEventListener('click',(e)=>{e.preventDefault();runPrediction();});
})();
</script>
</body>
</html>
