<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>Astro Football • Panchapakshi</title>
  <meta name="viewport" content="width=device-width,initial-scale=1.0" />
  <style>
    :root{
      --home-main:#0ea5e9;
      --away-main:#22c55e;
    }
    *{box-sizing:border-box;}
    body{
      margin:0;
      font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;
      background:#ffffff;
      color:#111827;
    }
    .wrap{max-width:1000px;margin:0 auto;padding:12px 10px 40px;}
    h1{
      font-size:16px;
      letter-spacing:0.3em;
      text-transform:uppercase;
      color:#4b5563;
      margin:4px 0 10px;
      text-align:center;
    }
    .subtitle{
      text-align:center;
      font-size:11px;
      text-transform:uppercase;
      letter-spacing:0.18em;
      color:#9ca3af;
      margin-bottom:14px;
    }
    .card{
      background:#f3f4f6;
      border-radius:16px;
      border:1px solid #e5e7eb;
      padding:12px;
      margin-bottom:12px;
      box-shadow:0 10px 25px rgba(15,23,42,0.06);
    }
    .title-sm{
      font-size:12px;
      text-transform:uppercase;
      letter-spacing:0.22em;
      color:#6b7280;
      margin-bottom:8px;
    }
    label{
      display:block;
      font-size:10px;
      text-transform:uppercase;
      letter-spacing:0.18em;
      color:#9ca3af;
      margin-bottom:3px;
    }
    input,select{
      width:100%;
      padding:8px 10px;
      border-radius:10px;
      border:1px solid #d1d5db;
      background:#ffffff;
      color:#111827;
      font-size:13px;
      margin-bottom:8px;
    }
    input:focus,select:focus{
      outline:none;
      border-color:#0ea5e9;
      box-shadow:0 0 0 1px #0ea5e9;
    }
    button{
      width:100%;
      padding:9px 10px;
      border:none;
      border-radius:999px;
      text-transform:uppercase;
      letter-spacing:0.18em;
      font-size:11px;
      font-weight:600;
      color:#ffffff;
      cursor:pointer;
      margin-bottom:4px;
    }
    .btn-main{
      background:linear-gradient(90deg,#2563eb,#22c55e);
      box-shadow:0 8px 18px rgba(37,99,235,0.25);
    }
    .btn-home{
      background:linear-gradient(90deg,var(--home-main),#38bdf8);
      box-shadow:0 8px 18px rgba(56,189,248,0.3);
    }
    .btn-away{
      background:linear-gradient(90deg,var(--away-main),#22c55e);
      box-shadow:0 8px 18px rgba(34,197,94,0.3);
    }
    .btn-danger{
      background:linear-gradient(90deg,#f97316,#ef4444);
      box-shadow:0 8px 18px rgba(248,113,113,0.4);
    }
    button:active{transform:scale(.97);}
    .row{display:flex;gap:8px;flex-wrap:wrap;}
    .row>div{flex:1;min-width:0;}
    .tiny{
      font-size:11px;
      color:#6b7280;
      margin-top:4px;
      line-height:1.5;
    }
    .tag{
      font-weight:600;
      text-transform:uppercase;
      letter-spacing:0.12em;
      font-size:10px;
      padding:2px 8px;
      border-radius:999px;
      display:inline-block;
      margin-right:6px;
    }
    .tag-info{background:#dbeafe;color:#1d4ed8;}
    .tag-toss{background:#e0f2fe;color:#0369a1;}
    .tag-match{background:#bbf7d0;color:#166534;}
    .tag-overall{background:#fee2a7;color:#92400e;}

    table{
      width:100%;
      border-collapse:collapse;
      font-size:11px;
    }
    th,td{
      border:1px solid #e5e7eb;
      padding:4px 6px;
      text-align:left;
    }
    th{
      background:#e5f3ff;
      color:#374151;
      text-transform:uppercase;
      letter-spacing:0.08em;
      font-size:10px;
    }
    tr:nth-child(even){background:#ffffff;}
    tr:nth-child(odd){background:#f9fafb;}
    tr.clickable{cursor:pointer;}
    tr.clickable:hover{background:#dbeafe;}

    .match-table-wrap{
      max-height:280px;
      overflow-y:auto;
      border-radius:12px;
      border:1px solid #e5e7eb;
      background:#ffffff;
    }

    .live-dot{
      color:#ef4444;
      font-weight:700;
      font-size:11px;
    }

    .team-home{color:var(--home-main);font-weight:600;}
    .team-away{color:var(--away-main);font-weight:600;}
    .winner-name{font-weight:700;color:#16a34a;}
    .good-text{color:#22c55e;font-weight:600;}
    .excellent-text{color:#15803d;font-weight:700;}
    .weak-text{color:#ef4444;font-weight:600;}

    .player-line{font-size:11px;line-height:1.5;}

    .bar-wrap{
      width:100%;
      height:14px;
      border-radius:999px;
      overflow:hidden;
      background:#e5e7eb;
      border:1px solid #d1d5db;
      margin:6px 0 4px 0;
      display:flex;
      position:relative;
    }
    .bar-fill{height:100%;}
    .bar-home{background:linear-gradient(90deg,var(--home-main),#38bdf8);}
    .bar-away{background:linear-gradient(90deg,var(--away-main),#22c55e);}
    .bar-label{
      position:absolute;
      left:50%;
      top:50%;
      transform:translate(-50%,-50%);
      font-size:10px;
      font-weight:600;
      white-space:nowrap;
      color:#ffffff;
      text-shadow:0 1px 2px rgba(0,0,0,0.6);
    }

    @media (max-width:600px){
      th:nth-child(4),td:nth-child(4){display:none;} /* hide league col on small screens */
    }
  </style>
</head>
<body>
<div class="wrap">
  <h1>ASTRO FOOTBALL</h1>
  <div class="subtitle">PURE PANCHAPAKSHI PREDICTION</div>

  <!-- STEP 1 – API MATCHES -->
  <div class="card">
    <div class="title-sm">Step 1 · Load Football Matches (API-Football)</div>
    <div class="row">
      <div>
        <label>API Key (api-football.com)</label>
        <input id="apiKey" placeholder="Paste your API key" />
      </div>
      <div>
        <label>Matches</label>
        <select id="matchFilter">
          <option value="today">Today · Live & Upcoming</option>
          <option value="tomorrow">Tomorrow</option>
        </select>
      </div>
      <div style="flex:0 0 120px;">
        <label>&nbsp;</label>
        <button class="btn-main" id="btnLoad">Load</button>
      </div>
    </div>
    <div class="tiny">
      <span class="tag tag-info">Info</span>
      Your API key is used only in your browser. Click a match row below to send it into the Panchapakshi engine.
      <br>Red <span class="live-dot">● LIVE</span> means the match is currently in play.
    </div>

    <div id="matchesWrap" class="match-table-wrap" style="margin-top:8px;">
      <table>
        <thead>
          <tr>
            <th>Kickoff</th>
            <th>Home</th>
            <th>Away</th>
            <th>League</th>
            <th>City / Country</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody id="matchesBody">
          <tr><td colspan="6" style="text-align:center;">No matches loaded.</td></tr>
        </tbody>
      </table>
    </div>
  </div>

  <!-- STEP 2 – MATCH INPUT -->
  <div class="card">
    <div class="title-sm">Step 2 · Match Input (auto-filled from API or manual)</div>

    <div class="row">
      <div>
        <label>Home Team</label>
        <input id="homeTeam" placeholder="Home team name" />
      </div>
      <div>
        <label>Away Team</label>
        <input id="awayTeam" placeholder="Away team name" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>Kickoff Date (venue)</label>
        <input id="kickDate" type="date" />
      </div>
      <div>
        <label>Kickoff Time (venue)</label>
        <input id="kickTime" type="time" />
      </div>
      <div>
        <label>Venue Timezone (from API)</label>
        <input id="venueTz" placeholder="Ex: Europe/London" />
      </div>
    </div>

    <div class="row">
      <div>
        <label>League / Competition</label>
        <input id="league" placeholder="Ex: Premier League" />
      </div>
      <div>
        <label>City / Country</label>
        <input id="cityCountry" placeholder="Ex: Liverpool, England" />
      </div>
      <div>
        <label>Paksha (auto from date)</label>
        <select id="paksha">
          <option value="shukla">Shukla</option>
          <option value="krishna">Krishna</option>
        </select>
      </div>
    </div>

    <div class="row">
      <div>
        <label>Home Team Bird</label>
        <select id="homeBird">
          <option value="">Select bird</option>
          <option>Vulture</option>
          <option>Owl</option>
          <option>Crow</option>
          <option>Cock</option>
          <option>Peacock</option>
        </select>
      </div>
      <div>
        <label>Away Team Bird</label>
        <select id="awayBird">
          <option value="">Select bird</option>
          <option>Vulture</option>
          <option>Owl</option>
          <option>Crow</option>
          <option>Cock</option>
          <option>Peacock</option>
        </select>
      </div>
    </div>
  </div>

  <!-- STEP 3 – 27 NAKSHATRA PLAYERS -->
  <div class="card">
    <div class="title-sm">Teams · 27 Nakshatra → Bird (11 Players)</div>

    <div class="row">
      <!-- Home team players -->
      <div>
        <label>Home Team – 11 Players (DOB)</label>
        <table>
          <thead>
            <tr><th>#</th><th>Name</th><th>DOB</th></tr>
          </thead>
          <tbody id="homePlayersBody"></tbody>
        </table>
      </div>
      <!-- Away team players -->
      <div>
        <label>Away Team – 11 Players (DOB)</label>
        <table>
          <thead>
            <tr><th>#</th><th>Name</th><th>DOB</th></tr>
          </thead>
          <tbody id="awayPlayersBody"></tbody>
        </table>
      </div>
    </div>

    <div class="row" style="margin-top:6px;">
      <div>
        <button class="btn-home" id="btnCalcPlayers">Calc Team Birds (27 Nakshatra)</button>
      </div>
      <div>
        <button class="btn-main" id="btnPredict">Run Panchapakshi Prediction</button>
      </div>
    </div>

    <div id="playersSummary" class="tiny"></div>
  </div>

  <!-- SUMMARY -->
  <div id="summaryCard" class="card" style="display:none;">
    <div class="title-sm">Astro Match Summary – Panchapakshi Only</div>

    <div id="dayInfo" class="tiny"></div>
    <div id="teamSummaryHome" class="tiny"></div>
    <div id="teamSummaryAway" class="tiny"></div>

    <div id="envBarLine" class="tiny"></div>
    <div id="overallLine" class="tiny"></div>
    <div id="drawLine" class="tiny"></div>
  </div>
</div>

<script>
/* ---------- CONSTANTS ---------- */
const BIRDS = ['Vulture','Owl','Crow','Cock','Peacock'];
const DAY_PLANETS = ['Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn'];

const BIRD_PLANETS = {
  shukla: {
    Vulture: ['Jupiter','Saturn'],
    Owl:     ['Sun','Venus'],
    Crow:    ['Moon'],
    Cock:    ['Mars'],
    Peacock: ['Mercury']
  },
  krishna: {
    Vulture: ['Mars'],
    Owl:     ['Moon'],
    Crow:    ['Sun'],
    Cock:    ['Jupiter','Saturn'],
    Peacock: ['Mercury','Venus']
  }
};

const FRIENDLY_BIRDS = {
  Vulture: ['Owl','Cock'],
  Owl:     ['Vulture','Peacock'],
  Crow:    ['Peacock','Cock'],
  Cock:    ['Vulture','Crow'],
  Peacock: ['Owl','Crow']
};
const UNFRIENDLY_BIRDS = {
  Vulture: ['Peacock','Crow'],
  Owl:     ['Crow','Cock'],
  Crow:    ['Vulture','Owl'],
  Cock:    ['Peacock','Owl'],
  Peacock: ['Vulture','Cock']
};

const PLAYER_NAK_BIRDS = [
  'Peacock','Peacock','Peacock','Peacock','Peacock',
  'Cock','Cock','Cock','Cock','Cock','Cock',
  'Crow','Crow','Crow','Crow','Crow',
  'Owl','Owl','Owl','Owl','Owl',
  'Vulture','Vulture','Vulture','Vulture','Vulture','Vulture'
];

/* New activity strengths: Rule 100, Eat 80, Walk 50, Sleep 30, Die 0 */
const APAHARA_DURATIONS={Rule:48,Eat:30,Walk:36,Sleep:18,Die:12};
const ACTIVITY_STRENGTH={
  Rule:{score:100},
  Eat:{score:80},
  Walk:{score:50},
  Sleep:{score:30},
  Die:{score:0}
};
const ACTIVITY_CYCLES={
  shukla_day:['Eat','Walk','Rule','Sleep','Die'],
  shukla_night:['Eat','Rule','Die','Walk','Sleep'],
  krishna_day:['Eat','Die','Sleep','Rule','Walk'],
  krishna_night:['Eat','Sleep','Walk','Die','Rule']
};

function deriveRulingBirds(paksha){
  const map = BIRD_PLANETS[paksha];
  const arr=[];
  for(let d=0;d<7;d++){
    const planet=DAY_PLANETS[d];
    let chosen='Vulture';
    for(const bird of BIRDS){
      const list=map[bird]||[];
      if(list.includes(planet)){chosen=bird;break;}
    }
    arr.push(chosen);
  }
  return arr;
}
const RULING_BIRDS = {
  shukla: deriveRulingBirds('shukla'),
  krishna: deriveRulingBirds('krishna')
};

let loadedFixtures=[];

/* ---------- HELPERS ---------- */
function timeToMins(t){
  if(!t)return 0;
  const [h,m]=t.split(':').map(Number);
  return h*60+m;
}
function minsToTime(m){
  let x=m;
  while(x<0)x+=1440;
  x=x%1440;
  const h=Math.floor(x/60);
  const mm=x%60;
  return h.toString().padStart(2,'0')+":"+mm.toString().padStart(2,'0');
}

/* DOB → day-of-year (fixed year 2001 so birds stable) */
function dayOfYearFromDOB(dobStr){
  if(!dobStr)return null;
  const parts = dobStr.split("-");
  if(parts.length!==3)return null;
  const m=Number(parts[1])-1;
  const d=Number(parts[2]);
  const baseYear=2001;
  const dt=new Date(baseYear,m,d);
  if(isNaN(dt))return null;
  const start=new Date(baseYear,0,0);
  const diff=dt-start;
  const oneDay=1000*60*60*24;
  return Math.floor(diff/oneDay);
}

/* moon age → auto paksha */
function computeMoonAge(date){
  const year=date.getUTCFullYear();
  const month=date.getUTCMonth()+1;
  const day=date.getUTCDate();
  let yy = year - Math.floor((12 - month)/10);
  let mm = month + 9;
  if(mm>=12)mm-=12;
  const k1=Math.floor(365.25*(yy+4712));
  const k2=Math.floor(30.6*mm+0.5);
  const k3=Math.floor(Math.floor((yy/100)+49)*0.75)-38;
  const jd=k1+k2+day+59-k3;
  const ip=(jd-2451550.1)/29.530588853;
  const frac=ip-Math.floor(ip);
  return frac*29.530588853;
}
function autoPakshaFromDate(dateStr){
  if(!dateStr)return 'shukla';
  const d=new Date(dateStr+'T12:00:00Z');
  const age=computeMoonAge(d);
  return age<14.765?'shukla':'krishna';
}

/* Panchapakshi engine – yama context */
function getMainYamaContext(bird,timeMins,dayIdx,pakshaType){
  const dayStart=360, nightStart=1080, yamaDuration=144;
  let isNight=false,minsSinceStart=0,cycleStartMins=dayStart;
  let t=timeMins;
  if(t<dayStart)t+=1440;
  if(t>=dayStart && t<nightStart){
    isNight=false;
    minsSinceStart=t-dayStart;
    cycleStartMins=dayStart;
  }else{
    isNight=true;
    if(t>=nightStart){
      minsSinceStart=t-nightStart;
      cycleStartMins=nightStart;
    }else{
      minsSinceStart=(t+1440)-nightStart;
      cycleStartMins=nightStart;
    }
  }
  const yamaIndex=Math.floor(minsSinceStart/yamaDuration);
  const clamped=Math.min(yamaIndex,4);
  const key=pakshaType+'_'+(isNight?'night':'day');
  const cycle=ACTIVITY_CYCLES[key];
  const ruling=RULING_BIRDS[pakshaType][dayIdx];

  const bi=BIRDS.indexOf(bird);
  const ri=BIRDS.indexOf(ruling);
  const dist=(bi-ri+5)%5;
  const actIdx=(clamped+dist)%5;
  const mainActivity=cycle[actIdx];
  const yamaStartTime=cycleStartMins+clamped*144;
  return {mainActivity,yamaStartTime,activityCycle:cycle};
}

function generateSegments(bird,rangeStart,rangeEnd,dayIdx,pakshaType){
  let segments=[];
  let current=rangeStart;
  while(current<rangeEnd){
    const {mainActivity,yamaStartTime,activityCycle}=getMainYamaContext(
      bird,current%1440,dayIdx,pakshaType
    );
    const mainIdx=activityCycle.indexOf(mainActivity);
    let subStart=yamaStartTime;
    let subs=[];
    for(let i=0;i<5;i++){
      const act=activityCycle[(mainIdx+i)%5];
      const dur=APAHARA_DURATIONS[act];
      subs.push({
        activity:act,
        start:subStart,
        end:subStart+dur,
        score:ACTIVITY_STRENGTH[act].score
      });
      subStart+=dur;
    }
    for(const s of subs){
      const effStart=Math.max(current,s.start);
      const effEnd=Math.min(rangeEnd,s.end);
      if(effEnd>effStart){
        segments.push({
          startMins:effStart,
          endMins:effEnd,
          activity:s.activity,
          score:s.score,
          duration:effEnd-effStart
        });
        current=effEnd;
      }
    }
    if(current<yamaStartTime+144)current=yamaStartTime+144;
    if(current>=rangeEnd)break;
  }
  return segments;
}

/* ---------- UI HELPERS ---------- */
function renderBar(pHome,pAway,labelHome,labelAway){
  return `
    <div class="bar-wrap">
      <div class="bar-fill bar-home" style="width:${pHome}%;"></div>
      <div class="bar-fill bar-away" style="width:${pAway}%;"></div>
      <div class="bar-label"><span class="team-home">${labelHome}</span> • <span class="team-away">${labelAway}</span></div>
    </div>
  `;
}

/* ---------- PLAYERS TABLE BUILD ---------- */
function buildPlayersTable(){
  const homeBody=document.getElementById('homePlayersBody');
  const awayBody=document.getElementById('awayPlayersBody');
  homeBody.innerHTML='';
  awayBody.innerHTML='';
  for(let i=1;i<=11;i++){
    const tr1=document.createElement('tr');
    tr1.innerHTML=
      `<td>${i===1?'1 C':i}</td>
       <td><input id="h_name_${i}" placeholder="Player ${i}" /></td>
       <td><input id="h_dob_${i}" type="date" /></td>`;
    homeBody.appendChild(tr1);
    const tr2=document.createElement('tr');
    tr2.innerHTML=
      `<td>${i===1?'1 C':i}</td>
       <td><input id="a_name_${i}" placeholder="Player ${i}" /></td>
       <td><input id="a_dob_${i}" type="date" /></td>`;
    awayBody.appendChild(tr2);
  }
}
buildPlayersTable();

/* ---------- API LOAD MATCHES ---------- */
async function loadMatches(){
  const key=document.getElementById('apiKey').value.trim();
  if(!key){alert('Enter API key.');return;}
  const mode=document.getElementById('matchFilter').value;
  const now=new Date();
  let useDate=new Date(now);
  if(mode==='tomorrow')useDate.setDate(now.getDate()+1);
  const dateStr=useDate.toISOString().slice(0,10);

  const url=`https://v3.football.api-sports.io/fixtures?date=${dateStr}`;

  const res=await fetch(url,{
    headers:{
      'x-apisports-key':key
    }
  }).catch(e=>({ok:false}));
  if(!res || !res.ok){
    alert('API error. Check key or network.');
    return;
  }
  const data=await res.json();
  loadedFixtures=data.response||[];
  const tbody=document.getElementById('matchesBody');
  tbody.innerHTML='';

  if(!loadedFixtures.length){
    tbody.innerHTML='<tr><td colspan="6" style="text-align:center;">No matches for this day.</td></tr>';
    return;
  }

  loadedFixtures.forEach((fx,idx)=>{
    const fixture=fx.fixture;
    const league=fx.league;
    const home=fx.teams.home.name;
    const away=fx.teams.away.name;
    const city=(fixture.venue.city||'')+', '+(fixture.venue.country||'');
    const statusShort=fixture.status.short;
    const statusLong=fixture.status.long || statusShort;
    const isLive=['1H','2H','ET','P','BT','INT','LIVE'].includes(statusShort);

    const kick = new Date(fixture.date);
    const tz = fixture.timezone || 'UTC';
    const timeStr = kick.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',timeZone:tz});
    const dateLocal = kick.toLocaleDateString('en-CA',{timeZone:tz}); // YYYY-MM-DD

    const tr=document.createElement('tr');
    tr.className='clickable';
    tr.dataset.index=idx;
    tr.innerHTML=
      `<td>${dateLocal} ${timeStr}</td>
       <td>${home}</td>
       <td>${away}</td>
       <td>${league.name}</td>
       <td>${city}</td>
       <td>${isLive?'<span class="live-dot">● LIVE</span>':statusShort}</td>`;
    tr.addEventListener('click',()=>fillFromFixture(idx));
    tbody.appendChild(tr);
  });
}

function fillFromFixture(idx){
  const fx=loadedFixtures[idx];
  if(!fx)return;
  const fixture=fx.fixture;
  const league=fx.league;
  const home=fx.teams.home;
  const away=fx.teams.away;

  const tz=fixture.timezone || 'UTC';
  const kick=new Date(fixture.date);
  const dateLocal=kick.toLocaleDateString('en-CA',{timeZone:tz});
  const timeStr=kick.toLocaleTimeString('en-GB',{hour:'2-digit',minute:'2-digit',timeZone:tz});

  document.getElementById('homeTeam').value=home.name;
  document.getElementById('awayTeam').value=away.name;
  document.getElementById('kickDate').value=dateLocal;
  document.getElementById('kickTime').value=timeStr;
  document.getElementById('venueTz').value=tz;
  document.getElementById('league').value=league.name;
  const city=(fixture.venue.city||'')+', '+(fixture.venue.country||'');
  document.getElementById('cityCountry').value=city;

  // auto paksha from kickoff date
  const pk=autoPakshaFromDate(dateLocal);
  document.getElementById('paksha').value=pk;
}

/* ---------- TEAM PLAYERS PANCHAPAKSHI ---------- */
function getTeamPlayers(sidePrefix){ // 'h' or 'a'
  const arr=[];
  for(let i=1;i<=11;i++){
    const name=document.getElementById(`${sidePrefix}_name_${i}`).value.trim() || `Player ${i}`;
    const dob=document.getElementById(`${sidePrefix}_dob_${i}`).value;
    if(dob)arr.push({i,name,dob});
  }
  return arr;
}

function calcPlayers(){
  const dateStr=document.getElementById('kickDate').value;
  if(!dateStr){
    alert('Set kickoff date first.');
    return;
  }
  const paksha=document.getElementById('paksha').value;
  const d=new Date(dateStr+'T12:00:00Z');
  const dayIdx=d.getUTCDay();
  const ruling=RULING_BIRDS[paksha][dayIdx];
  const friendly=FRIENDLY_BIRDS[ruling]||[];
  const enemy=UNFRIENDLY_BIRDS[ruling]||[];

  const homeTeam=document.getElementById('homeTeam').value||'Home';
  const awayTeam=document.getElementById('awayTeam').value||'Away';

  const homePlayers=getTeamPlayers('h');
  const awayPlayers=getTeamPlayers('a');

  function teamBlock(label,players,side){
    if(!players.length)return `${label}: no players entered.<br><br>`;
    let birdCount={Vulture:0,Owl:0,Crow:0,Cock:0,Peacock:0};
    let ex=[],good=[],weak=[];
    let lines=[];
    players.forEach(p=>{
      const dayNo=dayOfYearFromDOB(p.dob);
      if(!dayNo){
        lines.push(`<div class="player-line">${p.i}. <b>${p.name}</b>: DOB error.</div>`);
        return;
      }
      const idx=(dayNo-1)%27;
      const starNo=idx+1;
      const bird=PLAYER_NAK_BIRDS[idx];
      birdCount[bird]++;

      let cls='',tag='';
      if(bird===ruling){
        cls='excellent-text';tag='Excellent';ex.push(p.name);
      }else if(friendly.includes(bird)){
        cls='good-text';tag='Good';good.push(p.name);
      }else if(enemy.includes(bird)){
        cls='weak-text';tag='Weak';weak.push(p.name);
      }
      lines.push(
        `<div class="player-line">${p.i}. <b>${p.name}</b>: ${p.dob} → Star ${starNo} → Bird <span class="${cls}">${bird}${tag?(' – '+tag):''}</span></div>`
      );
    });

    let domBird=null,max=0;
    for(const b of BIRDS){
      if(birdCount[b]>max){max=birdCount[b];domBird=b;}
    }
    if(side==='home' && domBird)document.getElementById('homeBird').value=domBird;
    if(side==='away' && domBird)document.getElementById('awayBird').value=domBird;

    const spread=BIRDS.map(b=>birdCount[b]?`${b} × ${birdCount[b]}`:null).filter(Boolean).join(', ');

    return `<b>${label}</b><br>
            Bird spread: ${spread||'-'}<br>
            Excellent: <span class="excellent-text">${ex.length}</span> (${ex.join(', ')||'-'})<br>
            Good: <span class="good-text">${good.length}</span> (${good.join(', ')||'-'})<br>
            Weak: <span class="weak-text">${weak.length}</span> (${weak.join(', ')||'-'})<br>
            ${lines.join('')}<br>`;
  }

  let html=
    `Day ruling bird: <span class="excellent-text">${ruling}</span> • 
     Friendly: <span class="good-text">${friendly.join(', ')||'-'}</span> • 
     Enemy: <span class="weak-text">${enemy.join(', ')||'-'}</span><br><br>`;

  html+=teamBlock(homeTeam,homePlayers,'home');
  html+=teamBlock(awayTeam,awayPlayers,'away');
  document.getElementById('playersSummary').innerHTML=html;
}

/* ---------- PREDICTION ---------- */
function runPrediction(){
  const homeTeam=document.getElementById('homeTeam').value||'Home';
  const awayTeam=document.getElementById('awayTeam').value||'Away';
  const dateStr=document.getElementById('kickDate').value;
  const timeStr=document.getElementById('kickTime').value;
  const paksha=document.getElementById('paksha').value;
  const homeBird=document.getElementById('homeBird').value;
  const awayBird=document.getElementById('awayBird').value;

  if(!dateStr||!timeStr){alert('Set kickoff date and time.');return;}
  if(!homeBird||!awayBird){alert('Set both team birds (use Calc Team Birds).');return;}

  const d=new Date(dateStr+'T12:00:00Z');
  const dayIdx=d.getUTCDay();
  const ruling=RULING_BIRDS[paksha][dayIdx];
  const friendly=FRIENDLY_BIRDS[ruling]||[];
  const enemy=UNFRIENDLY_BIRDS[ruling]||[];

  const start=timeToMins(timeStr);
  const end=start+120; // 90 + extra

  const segHome=generateSegments(homeBird,start,end,dayIdx,paksha);
  const segAway=generateSegments(awayBird,start,end,dayIdx,paksha);

  let totalDur=0,accHome=0;
  const pushSegPercent=(segs1,segs2)=>{
    let points=new Set([start,end]);
    segs1.forEach(s=>{points.add(s.startMins);points.add(s.endMins);});
    segs2.forEach(s=>{points.add(s.startMins);points.add(s.endMins);});
    const sorted=[...points].sort((a,b)=>a-b);
    for(let i=0;i<sorted.length-1;i++){
      const p1=sorted[i],p2=sorted[i+1],dur=p2-p1;
      const a1=segs1.find(s=>s.startMins<=p1 && s.endMins>=p2);
      const a2=segs2.find(s=>s.startMins<=p1 && s.endMins>=p2);
      if(a1&&a2){
        const tot=a1.score+a2.score||1;
        const pHome=(a1.score/tot)*100;
        accHome+=pHome*dur;
        totalDur+=dur;
      }
    }
  };
  pushSegPercent(segHome,segAway);
  const envHome = totalDur? accHome/totalDur : 50;
  const envAway = 100-envHome;

  // bonus from day ruling friendliness
  function bonusForBird(bird){
    if(bird===ruling)return 10;
    if(friendly.includes(bird))return 5;
    if(enemy.includes(bird))return -8;
    return 0;
  }
  const bonusHome=bonusForBird(homeBird);
  const bonusAway=bonusForBird(awayBird);

  let scoreHome=envHome+bonusHome;
  let scoreAway=envAway+bonusAway;

  // normalize to 0–100 and clamp 30–70
  const sum=scoreHome+scoreAway||1;
  scoreHome=(scoreHome/sum)*100;
  scoreAway=100-scoreHome;
  const clamp=p=>p>70?70:p<30?30:p;
  scoreHome=clamp(scoreHome);
  scoreAway=clamp(scoreAway);

  let winner="Balanced / 50-50";
  if(scoreHome>scoreAway+1)winner=homeTeam;
  else if(scoreAway>scoreHome+1)winner=awayTeam;

  const diff=Math.abs(scoreHome-scoreAway);
  const drawYes = diff<4;

  /* ---------- render ---------- */
  document.getElementById('summaryCard').style.display='block';

  document.getElementById('dayInfo').innerHTML=
    `<span class="tag tag-info">Day Bird</span>`+
    `Ruling bird: <span class="excellent-text">${ruling}</span> • `+
    `Friendly: <span class="good-text">${friendly.join(', ')||'-'}</span> • `+
    `Enemy: <span class="weak-text">${enemy.join(', ')||'-'}</span>`;

  document.getElementById('teamSummaryHome').innerHTML=
    `<b>${homeTeam}</b> bird: <span class="team-home">${homeBird}</span>`;
  document.getElementById('teamSummaryAway').innerHTML=
    `<b>${awayTeam}</b> bird: <span class="team-away">${awayBird}</span>`;

  document.getElementById('envBarLine').innerHTML =
    `<span class="tag tag-match">Panchapakshi %</span>`+
    renderBar(
      scoreHome,scoreAway,
      `${homeTeam} ${scoreHome.toFixed(1)}%`,
      `${awayTeam} ${scoreAway.toFixed(1)}%`
    );

  let homeCls='team-home',awayCls='team-away';
  if(winner===homeTeam){homeCls='excellent-text';awayCls='weak-text';}
  else if(winner===awayTeam){homeCls='weak-text';awayCls='excellent-text';}

  document.getElementById('overallLine').innerHTML=
    `<span class="tag tag-overall">Overall Winner</span>`+
    `Result: <span class="winner-name">${winner}</span><br>`+
    `<span class="${homeCls}">${homeTeam}</span> ${scoreHome.toFixed(1)}% • `+
    `<span class="${awayCls}">${awayTeam}</span> ${scoreAway.toFixed(1)}%`;

  document.getElementById('drawLine').innerHTML =
    `Draw (Yes / No): <b>${drawYes?'Yes – almost equal birds / activity':'No – clear edge for winner'}</b>`;
}

/* ---------- EVENT BIND ---------- */
document.getElementById('btnLoad').addEventListener('click',loadMatches);
document.getElementById('btnCalcPlayers').addEventListener('click',calcPlayers);
document.getElementById('btnPredict').addEventListener('click',runPrediction);
document.getElementById('kickDate').addEventListener('change',e=>{
  const pk=autoPakshaFromDate(e.target.value);
  document.getElementById('paksha').value=pk;
});
</script>
</body>
</html>
