<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8" />
<title>Astro Football ‚Ä¢ Pure Panchapakshi</title>
<meta name="viewport" content="width=device-width,initial-scale=1.0" />
<style>
  :root{
    --home:#0ea5e9;
    --away:#22c55e;
  }
  *{box-sizing:border-box;font-family:system-ui,-apple-system,BlinkMacSystemFont,"Segoe UI",sans-serif;}
  body{margin:0;background:#ffffff;color:#111827;}
  .wrap{max-width:960px;margin:0 auto;padding:12px;}
  h1{font-size:20px;letter-spacing:0.35em;text-transform:uppercase;color:#6b7280;}
  .tagline{font-size:11px;color:#9ca3af;margin-bottom:10px;}

  .card{
    background:#f9fafb;
    border:1px solid #e5e7eb;
    border-radius:18px;
    padding:12px;
    margin-bottom:12px;
    box-shadow:0 10px 25px rgba(15,23,42,0.06);
  }
  .title-sm{
    font-size:12px;
    text-transform:uppercase;
    letter-spacing:0.22em;
    color:#6b7280;
    margin-bottom:6px;
  }
  label{
    display:block;
    font-size:10px;
    text-transform:uppercase;
    letter-spacing:0.18em;
    color:#9ca3af;
    margin-bottom:3px;
  }
  input,select{
    width:100%;
    padding:8px 10px;
    border-radius:10px;
    border:1px solid #d1d5db;
    background:#ffffff;
    color:#111827;
    font-size:13px;
    margin-bottom:8px;
  }
  input:focus,select:focus{
    outline:none;
    border-color:#0ea5e9;
    box-shadow:0 0 0 1px #0ea5e9;
  }
  button{
    border:none;
    border-radius:999px;
    padding:9px 12px;
    font-size:11px;
    font-weight:600;
    letter-spacing:0.18em;
    text-transform:uppercase;
    cursor:pointer;
  }
  .btn-main{
    background:linear-gradient(90deg,#22c55e,#16a34a);
    color:#fff;
    width:100%;
    margin-bottom:4px;
  }
  .btn-sub{
    background:linear-gradient(90deg,#0ea5e9,#6366f1);
    color:#fff;
    width:100%;
    margin-bottom:4px;
  }
  .btn-small{
    padding:6px 10px;
    font-size:10px;
    letter-spacing:0.16em;
  }
  button:active{transform:scale(.97);}
  .row{display:flex;gap:8px;flex-wrap:wrap;}
  .row>div{flex:1;}
  .tiny{
    font-size:11px;
    color:#6b7280;
    margin-top:4px;
    line-height:1.5;
  }

  /* table area: chinna scroll */
  .table-wrap{
    margin-top:6px;
    max-height:360px;        /* <= height of list */
    overflow-y:auto;         /* inner scroll */
    border-radius:12px;
    border:1px solid #e5e7eb;
    background:#ffffff;
  }

  table{
    width:100%;
    border-collapse:collapse;
    font-size:11px;
  }
  th,td{
    border-bottom:1px solid #e5e7eb;
    padding:4px 6px;
    text-align:left;
    vertical-align:middle;
  }
  th{
    background:#e5f3ff;
    text-transform:uppercase;
    letter-spacing:0.08em;
    font-size:10px;
    color:#374151;
    position:sticky;
    top:0;
    z-index:1;
  }
  tr:nth-child(even){background:#ffffff;}
  tr:nth-child(odd){background:#f9fafb;}
  tr.clickable:hover{background:#eef2ff;cursor:pointer;}

  .tag{
    display:inline-block;
    padding:2px 8px;
    border-radius:999px;
    font-size:10px;
    font-weight:600;
    letter-spacing:0.12em;
    text-transform:uppercase;
    margin-right:6px;
  }
  .tag-toss{background:#dbeafe;color:#1d4ed8;}
  .tag-flow{background:#e0f2fe;color:#075985;}
  .tag-score{background:#fef3c7;color:#92400e;}
  .tag-overall{background:#dcfce7;color:#166534;}
  .tag-draw{background:#fee2e2;color:#b91c1c;}

  .good-text{color:#22c55e;font-weight:600;}
  .weak-text{color:#ef4444;font-weight:600;}
  .winner-name{font-weight:700;color:#16a34a;}
  .team1-text{color:var(--home);font-weight:600;}
  .team2-text{color:var(--away);font-weight:600;}

  .bar-wrap{
    width:100%;
    height:14px;
    border-radius:999px;
    margin:6px 0 4px 0;
    background:#e5e7eb;
    border:1px solid #d1d5db;
    overflow:hidden;
    position:relative;
    display:flex;
  }
  .bar-fill{height:100%;}
  .bar-home{background:linear-gradient(90deg,var(--home),#38bdf8);}
  .bar-away{background:linear-gradient(90deg,var(--away),#22c55e);}
  .bar-midline{
    position:absolute;
    top:-1px;
    bottom:-1px;
    width:2px;
    background:#f97316;
    opacity:.9;
    pointer-events:none;
  }
  .bar-label{
    position:absolute;
    left:50%;
    top:50%;
    transform:translate(-50%,-50%);
    font-size:10px;
    font-weight:600;
    color:#fff;
    white-space:nowrap;
    text-shadow:0 1px 2px rgba(0,0,0,.6);
  }

  .summary-line{font-size:11.5px;margin:1px 0;}
  .summary-team-title{font-size:12px;font-weight:700;color:#111827;margin-top:4px;}

  .result-pass{color:#16a34a;font-weight:600;}
  .result-fail{color:#dc2626;font-weight:600;}
  .result-neutral{color:#6b7280;font-weight:600;}

  .btn-danger{
    background:#fee2e2;
    color:#b91c1c;
  }
</style>
</head>
<body>
<div class="wrap">
  <h1>ASTRO FOOTBALL</h1>
  <div class="tagline">Pure Panchapakshi ‚Ä¢ Football Only ‚Ä¢ Rule Lock üîí</div>

  <!-- STEP 1: LOAD MATCHES -->
  <div class="card">
    <div class="title-sm">Step 1 ¬∑ Load Football Matches (API-Football)</div>
    <div class="row">
      <div>
        <label>API Key (dashboard.api-football.com)</label>
        <input id="apiKey" placeholder="Paste your API key" value="YOUR_API_KEY_HERE">
      </div>
      <div>
        <label>Day</label>
        <input id="matchDay" type="date">
      </div>
    </div>
    <div class="row">
      <div>
        <button class="btn-sub" id="btnLoadMatches">Load Matches</button>
      </div>
    </div>
    <div id="apiInfo" class="tiny"></div>

    <!-- chinna scroll wrapper -->
    <div class="table-wrap">
      <table id="matchesTable">
        <thead>
          <tr>
            <th>Kickoff (Venue)</th>
            <th>Home</th>
            <th>Away</th>
            <th>League</th>
            <th>City / Country</th>
            <th>Status</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
  </div>

  <!-- STEP 2: MATCH INPUT -->
  <div class="card">
    <div class="title-sm">Step 2 ¬∑ Match Input (from API row or Manual)</div>
    <div class="row">
      <div>
        <label>Home team</label>
        <input id="homeTeam" placeholder="Home team name">
      </div>
      <div>
        <label>Away team</label>
        <input id="awayTeam" placeholder="Away team name">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Kickoff date (venue)</label>
        <input id="kickoffDate" type="date">
      </div>
      <div>
        <label>Kickoff time (venue)</label>
        <input id="kickoffTime" type="time" value="12:00">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Venue timezone (from API)</label>
        <input id="venueTz" placeholder="Ex: Asia/Seoul">
      </div>
      <div>
        <label>League / Competition</label>
        <input id="league" placeholder="Ex: Premier League">
      </div>
      <div>
        <label>City / Country</label>
        <input id="cityCountry" placeholder="Ex: Liverpool, England">
      </div>
    </div>

    <div class="row">
      <div>
        <label>Paksha (auto from date)</label>
        <select id="paksha">
          <option value="shukla">Shukla</option>
          <option value="krishna">Krishna</option>
        </select>
      </div>
      <div style="flex:2;display:flex;align-items:flex-end;justify-content:flex-end;">
        <!-- small blue auto button -->
        <button id="btnAutoBirds" class="btn-sub btn-small" style="max-width:240px;">
          Auto team birds from name (Lock)
        </button>
      </div>
    </div>

    <div class="tiny" id="dayBirdLine"></div>
    <div class="tiny" id="autoBirdLine"></div>
  </div>

  <!-- STEP 3: PANCHAPAKSHI PREDICTION -->
  <div class="card" id="step3Card" style="display:none;">
    <div class="title-sm">Step 3 ¬∑ Pure Panchapakshi Prediction (Auto Lock)</div>
    <button class="btn-main" id="btnPredict">Run Panchapakshi Prediction</button>

    <div id="predictionBlock" style="margin-top:8px;">
      <div id="teamBirdsLine" class="tiny"></div>
      <div id="flowBarLine" class="tiny"></div>
      <div id="drawLine" class="tiny"></div>
      <div id="scoreHintLine" class="tiny"></div>
      <div id="overallLine" class="tiny"></div>
      <div id="finalCallLine" class="tiny"></div>
    </div>
  </div>

  <!-- HISTORY -->
  <div class="card">
    <div class="title-sm">Prediction History (Local Device)</div>
    <div class="row">
      <div>
        <button class="btn-sub btn-small" id="btnUpdateResults">Update finished results (API)</button>
      </div>
      <div style="text-align:right;">
        <button class="btn-danger btn-small" id="btnClearHistory">Clear all</button>
      </div>
    </div>
    <div class="table-wrap" style="max-height:260px;">
      <table id="historyTable">
        <thead>
          <tr>
            <th>Date</th>
            <th>Match</th>
            <th>Your call</th>
            <th>Final score</th>
            <th>Status</th>
            <th>Delete</th>
          </tr>
        </thead>
        <tbody></tbody>
      </table>
    </div>
    <div class="tiny">* Stored only in this browser using localStorage.</div>
  </div>
</div>

<script>
/* ---------- globals ---------- */
let API_KEY = '';
let fixturesCache = [];
let currentFixtureId = null;
let selectedMatchLocal = null;
let historyList = [];

/* ---------- helpers ---------- */
const $ = (id) => document.getElementById(id);

function timeToMins(t){
  if(!t) return 0;
  const [h,m]=t.split(':').map(Number);
  return h*60+m;
}
function minsToTime(m){
  let x=m;
  while(x<0)x+=1440;
  x%=1440;
  const h=Math.floor(x/60);
  const mm=x%60;
  return h.toString().padStart(2,'0')+":"+mm.toString().padStart(2,'0');
}

/* venue local date + minute + weekday */
function getVenueLocalParts(isoUtcString, timeZone){
  const d = new Date(isoUtcString);
  const parts = new Intl.DateTimeFormat('en-GB',{
    timeZone,
    year:'numeric',
    month:'2-digit',
    day:'2-digit',
    hour:'2-digit',
    minute:'2-digit',
    weekday:'short',
    hourCycle:'h23'
  }).formatToParts(d);
  const get = type => parts.find(p=>p.type===type)?.value;
  const year = get('year');
  const month = get('month');
  const day = get('day');
  const hour = get('hour');
  const minute = get('minute');
  const weekday = get('weekday');

  const dateLocalStr = `${year}-${month}-${day}`;
  const minsFromMidnight = parseInt(hour,10)*60 + parseInt(minute,10);
  const mapDow={Sun:0,Mon:1,Tue:2,Wed:3,Thu:4,Fri:5,Sat:6};
  const dayOfWeek = mapDow[weekday] ?? 0;

  return {dateLocalStr, minsFromMidnight, dayOfWeek};
}

/* moon age ‚Üí paksha (simple) */
function computeMoonAge(date){
  const year=date.getUTCFullYear();
  const month=date.getUTCMonth()+1;
  const day=date.getUTCDate();
  let yy = year - Math.floor((12-month)/10);
  let mm = month + 9;
  if(mm>=12) mm-=12;
  const k1 = Math.floor(365.25*(yy+4712));
  const k2 = Math.floor(30.6*mm+0.5);
  const k3 = Math.floor(Math.floor((yy/100)+49)*0.75)-38;
  const jd = k1 + k2 + day + 59 - k3;
  const ip = (jd - 2451550.1)/29.530588853;
  const frac = ip - Math.floor(ip);
  return frac*29.530588853;
}
function autoPakshaFromDateStr(dateStr){
  const d = new Date(dateStr+"T00:00:00Z");
  const age = computeMoonAge(d);
  return age<14.765 ? 'shukla' : 'krishna';
}

/* Panchapakshi tables */
const BIRDS=['Vulture','Owl','Crow','Cock','Peacock'];
const FRIENDLY_BIRDS={
  Vulture:['Owl','Cock'],
  Owl:['Vulture','Peacock'],
  Crow:['Peacock','Cock'],
  Cock:['Vulture','Crow'],
  Peacock:['Owl','Crow']
};
const UNFRIENDLY_BIRDS={
  Vulture:['Peacock','Crow'],
  Owl:['Crow','Cock'],
  Crow:['Vulture','Owl'],
  Cock:['Peacock','Owl'],
  Peacock:['Vulture','Cock']
};
const DAY_PLANETS=['Sun','Moon','Mars','Mercury','Jupiter','Venus','Saturn'];
const BIRD_PLANETS={
  shukla:{
    Vulture:['Jupiter','Saturn'],
    Owl:['Sun','Venus'],
    Crow:['Moon'],
    Cock:['Mars'],
    Peacock:['Mercury']
  },
  krishna:{
    Vulture:['Mars'],
    Owl:['Moon'],
    Crow:['Sun'],
    Cock:['Jupiter','Saturn'],
    Peacock:['Mercury','Venus']
  }
};
function deriveRulingBirds(paksha){
  const map=BIRD_PLANETS[paksha];
  const arr=[];
  for(let d=0;d<7;d++){
    const planet=DAY_PLANETS[d];
    let chosen='Vulture';
    for(const b of BIRDS){
      if((map[b]||[]).includes(planet)){chosen=b;break;}
    }
    arr.push(chosen);
  }
  return arr;
}
const RULING_BIRDS={
  shukla:deriveRulingBirds('shukla'),
  krishna:deriveRulingBirds('krishna')
};
const ACTIVITY_STRENGTH={Rule:100,Eat:80,Walk:50,Sleep:30,Die:0};
const ACTIVITY_CYCLES={
  shukla_day:['Eat','Walk','Rule','Sleep','Die'],
  shukla_night:['Eat','Rule','Die','Walk','Sleep'],
  krishna_day:['Eat','Die','Sleep','Rule','Walk'],
  krishna_night:['Eat','Sleep','Walk','Die','Rule']
};
const APAHARA_DURATIONS={Rule:48,Eat:30,Walk:36,Sleep:18,Die:12};

/* numerology ‚Üí bird */
const NAK_BIRDS=[
  'Peacock','Peacock','Peacock','Peacock','Peacock',
  'Cock','Cock','Cock','Cock','Cock','Cock',
  'Crow','Crow','Crow','Crow','Crow',
  'Owl','Owl','Owl','Owl','Owl',
  'Vulture','Vulture','Vulture','Vulture','Vulture','Vulture'
];
const CHALDEAN={
  1:"AIJQYaijqy",
  2:"BKRbkr",
  3:"CGLScgls",
  4:"DMTdmt",
  5:"EHNXehnx",
  6:"UVWuvwx",
  7:"OZozo",
  8:"FPfp",
  9:"",
};
function nameToNumber(name){
  let sum=0;
  for(const ch of name.toUpperCase()){
    for(const [num,letters] of Object.entries(CHALDEAN)){
      if(letters.includes(ch)){sum+=parseInt(num,10);break;}
    }
  }
  if(sum===0) return 1;
  while(sum>27) sum = sum.toString().split('').reduce((a,b)=>a+parseInt(b,10),0);
  if(sum===0) sum=1;
  return sum;
}
function teamNameToBird(name,paksha){
  const n=nameToNumber(name);
  const nakIndex=(n-1)%27;
  const nakId=nakIndex+1;
  const bird=NAK_BIRDS[nakIndex];
  return {nakId,bird};
}

/* Panchapakshi time engine */
function getMainYamaContext(bird,timeMins,dayIdx,pakshaType){
  const dayStart=360, nightStart=1080, yamaDur=144;
  let isNight=false, minsSinceStart=0, cycleStart=dayStart;
  let t=timeMins;
  if(t<dayStart)t+=1440;
  if(t>=dayStart && t<nightStart){
    isNight=false;
    minsSinceStart=t-dayStart;
    cycleStart=dayStart;
  }else{
    isNight=true;
    if(t>=nightStart){
      minsSinceStart=t-nightStart;
      cycleStart=nightStart;
    }else{
      minsSinceStart=(t+1440)-nightStart;
      cycleStart=nightStart;
    }
  }
  const yamaIndex=Math.floor(minsSinceStart/yamaDur);
  const clamped=Math.min(yamaIndex,4);
  const key=pakshaType+'_'+(isNight?'night':'day');
  const cycle=ACTIVITY_CYCLES[key];
  const ruling=RULING_BIRDS[pakshaType][dayIdx];
  const bi=BIRDS.indexOf(bird);
  const ri=BIRDS.indexOf(ruling);
  const dist=(bi-ri+5)%5;
  const actIdx=(clamped+dist)%5;
  const mainActivity=cycle[actIdx];
  const yamaStart=cycleStart+(clamped*yamaDur);
  return {mainActivity,yamaStart,cycle};
}
function generateGranularSegments(bird,rangeStartMins,rangeEndMins,dayIdx,pakshaType){
  let segments=[];
  let current=rangeStartMins;
  while(current<rangeEndMins){
    const {mainActivity,yamaStart,cycle}=getMainYamaContext(bird,current%1440,dayIdx,pakshaType);
    const mainIndex=cycle.indexOf(mainActivity);
    let subStart=yamaStart;
    const subSegs=[];
    for(let i=0;i<5;i++){
      const act=cycle[(mainIndex+i)%5];
      const dur=APAHARA_DURATIONS[act];
      subSegs.push({activity:act,start:subStart,end:subStart+dur,score:ACTIVITY_STRENGTH[act]});
      subStart+=dur;
    }
    for(const s of subSegs){
      const effStart=Math.max(current,s.start);
      const effEnd=Math.min(rangeEndMins,s.end);
      if(effEnd>effStart){
        segments.push({
          startMins:effStart,
          endMins:effEnd,
          activity:s.activity,
          score:s.score,
          duration:effEnd-effStart
        });
        current=effEnd;
      }
    }
    if(current<yamaStart+144) current=yamaStart+144;
  }
  return segments;
}
function getExactStatusAtTime(bird,timeMins,dayIdx,pakshaType){
  const segs=generateGranularSegments(bird,timeMins,timeMins+1,dayIdx,pakshaType);
  if(segs.length) return segs[0];
  return {activity:'Die',score:0};
}

/* bar UI */
function makeBar(pHome,pAway,labelHome,labelAway){
  const p1=Math.max(0,Math.min(100,pHome));
  const p2=100-p1;
  return `
    <div class="bar-wrap">
      <div class="bar-midline" style="left:${p1}%;"></div>
      <div class="bar-fill bar-home" style="width:${p1}%;"></div>
      <div class="bar-fill bar-away" style="width:${p2}%;"></div>
      <div class="bar-label">
        <span class="team1-text">${labelHome}</span>
        &nbsp;‚Ä¢&nbsp;
        <span class="team2-text">${labelAway}</span>
      </div>
    </div>
  `;
}

/* history storage */
function loadHistory(){
  try{
    const raw=localStorage.getItem('astroFootballHistory');
    historyList = raw ? JSON.parse(raw) : [];
    // remove old broken "undefined" rows
    historyList = historyList.filter(h=>h && h.match && h.match!=='undefined');
  }catch(e){historyList=[];}
  renderHistory();
}
function saveHistory(){
  try{
    localStorage.setItem('astroFootballHistory',JSON.stringify(historyList));
  }catch(e){}
}
function deleteHistoryRow(idx){
  historyList.splice(idx,1);
  saveHistory();
  renderHistory();
}
function clearHistory(){
  historyList=[];
  saveHistory();
  renderHistory();
}
function renderHistory(){
  const tbody=$('historyTable').querySelector('tbody');
  tbody.innerHTML='';
  historyList.forEach((h,idx)=>{
    const tr=document.createElement('tr');
    tr.innerHTML=`
      <td>${h.date}</td>
      <td>${h.match}</td>
      <td>${h.call}</td>
      <td>${h.finalScore||'-'}</td>
      <td class="${
        h.status==='Pass'?'result-pass':
        h.status==='Fail'?'result-fail':'result-neutral'
      }">${h.status}</td>
      <td><button class="btn-small btn-danger" onclick="deleteHistoryRow(${idx})">X</button></td>
    `;
    tbody.appendChild(tr);
  });
}

/* ---------- Step 1: load matches ---------- */
async function loadMatches(){
  API_KEY = $('apiKey').value.trim();
  if(!API_KEY){$('apiInfo').textContent='Enter API key first.';return;}
  const dayStr=$('matchDay').value;
  if(!dayStr){$('apiInfo').textContent='Choose date.';return;}

  $('apiInfo').textContent='Loading from API‚Ä¶';

  /* status filter: only NS (upcoming) + live (1H,2H,ET,P) */
  const url=`https://v3.football.api-sports.io/fixtures?date=${dayStr}&timezone=UTC&status=NS,1H,2H,ET,P`;

  try{
    const res=await fetch(url,{
      headers:{'x-apisports-key':API_KEY}
    });
    const data=await res.json();
    if(data.errors && Object.keys(data.errors).length){
      $('apiInfo').textContent='API error: '+JSON.stringify(data.errors);
      return;
    }
    fixturesCache = data.response || [];
    const tbody=$('matchesTable').querySelector('tbody');
    tbody.innerHTML='';

    fixturesCache.forEach(fx=>{
      const fixture=fx.fixture;
      const league=fx.league;
      const home=fx.teams.home;
      const away=fx.teams.away;

      const statusShort = fixture.status.short; // NS, 1H, 2H, ET, P
      const isLive = ['1H','2H','ET','P'].includes(statusShort);

      const local = getVenueLocalParts(fixture.date, fixture.timezone);
      const koLabel = `${local.dateLocalStr} ${minsToTime(local.minsFromMidnight)} (${fixture.timezone})`;

      const statusHtml = isLive
        ? '<span style="color:#ef4444;font-weight:700;">‚óè LIVE</span>'
        : 'Upcoming';

      const tr=document.createElement('tr');
      tr.className='clickable';
      tr.innerHTML=`
        <td>${koLabel}</td>
        <td>${home.name}</td>
        <td>${away.name}</td>
        <td>${league.name}</td>
        <td>${league.country}${fixture.venue?.city?(' ‚Ä¢ '+fixture.venue.city):''}</td>
        <td>${statusHtml}</td>
      `;
      tr.addEventListener('click',()=>fillFromFixture(fx,local));
      tbody.appendChild(tr);
    });

    $('apiInfo').textContent='API call success. LIVE (‚óè) + UPCOMING only. Click a row to send the match into Step 2.';
  }catch(e){
    console.error(e);
    $('apiInfo').textContent='Network / API error. Check internet + key + quota.';
  }
}

function fillFromFixture(fx,local){
  const fixture=fx.fixture;
  const home=fx.teams.home;
  const away=fx.teams.away;
  const league=fx.league;

  $('homeTeam').value=home.name;
  $('awayTeam').value=away.name;
  $('kickoffDate').value=local.dateLocalStr;
  $('kickoffTime').value=minsToTime(local.minsFromMidnight);
  $('venueTz').value=fixture.timezone;
  $('league').value=league.name;
  $('cityCountry').value=(fixture.venue?.city||'')+(league.country? (fixture.venue?.city?' ‚Ä¢ ':'')+league.country :'');

  const pk = autoPakshaFromDateStr(local.dateLocalStr);
  $('paksha').value=pk;

  selectedMatchLocal = {
    date:local.dateLocalStr,
    mins:local.minsFromMidnight,
    dow:local.dayOfWeek,
    tz:fixture.timezone
  };
  currentFixtureId = fixture.id;

  updateDayBirdLine();
  $('step3Card').style.display='block';
}

/* ---------- Step 2: day bird + auto team birds ---------- */
function updateDayBirdLine(){
  const dateStr=$('kickoffDate').value;
  const pak=$('paksha').value;
  if(!dateStr){$('dayBirdLine').textContent='Set match date to see today ruling bird.';return;}
  const d=new Date(dateStr+"T00:00:00");
  const dayIdx=d.getDay();
  const ruling=RULING_BIRDS[pak][dayIdx];
  const friendly=FRIENDLY_BIRDS[ruling]||[];
  const enemy=UNFRIENDLY_BIRDS[ruling]||[];
  $('dayBirdLine').innerHTML =
    `Day bird: <span class="winner-name">${ruling}</span> ‚Ä¢ `+
    `Friendly: <span class="good-text">${friendly.join(', ')||'-'}</span> ‚Ä¢ `+
    `Enemy: <span class="weak-text">${enemy.join(', ')||'-'}</span>`;
}

function autoTeamBirds(){
  const home=$('homeTeam').value.trim();
  const away=$('awayTeam').value.trim();
  if(!home || !away){
    alert('Enter both team names first.');
    return;
  }
  const pak=$('paksha').value;
  const h=teamNameToBird(home,pak);
  const a=teamNameToBird(away,pak);
  $('autoBirdLine').innerHTML =
    `Auto team birds (locked): `+
    `<span class="team1-text">${home}</span> ‚Üí ${h.bird} ¬∑ `+
    `<span class="team2-text">${away}</span> ‚Üí ${a.bird} `+
    `<br><span class="tiny">(Name ‚Üí numerology ‚Üí 27 nakshatra ‚Üí bird. Manual change not allowed üîí)</span>`;
  $('step3Card').style.display='block';
  $('step3Card').dataset.homeBird=h.bird;
  $('step3Card').dataset.awayBird=a.bird;
}

/* ---------- Step 3: prediction ---------- */
function runPrediction(){
  const home=$('homeTeam').value.trim()||'Home';
  const away=$('awayTeam').value.trim()||'Away';
  const pak=$('paksha').value;
  let dateStr,dayIdx,tMins;

  if(selectedMatchLocal){
    dateStr=selectedMatchLocal.date;
    tMins=selectedMatchLocal.mins;
    dayIdx=selectedMatchLocal.dow;
  }else{
    dateStr=$('kickoffDate').value;
    const timeStr=$('kickoffTime').value;
    const tz=$('venueTz').value||'UTC';
    tMins=timeToMins(timeStr);
    const fakeIso=dateStr+"T"+timeStr+":00";
    const d=new Date(fakeIso);
    const parts=new Intl.DateTimeFormat('en-GB',{timeZone:tz,weekday:'short'}).formatToParts(d);
    const wd=parts.find(p=>p.type==='weekday').value;
    const map={Sun:0,Mon:1,Tue:2,Wed:3,Thu:4,Fri:5,Sat:6};
    dayIdx=map[wd]??0;
  }

  const homeBird=$('step3Card').dataset.homeBird;
  const awayBird=$('step3Card').dataset.awayBird;
  if(!homeBird || !awayBird){
    alert('Use "Auto team birds from name" first.');
    return;
  }

  const hStatus=getExactStatusAtTime(homeBird,tMins,dayIdx,pak);
  const aStatus=getExactStatusAtTime(awayBird,tMins,dayIdx,pak);
  const hScore=hStatus.score;
  const aScore=aStatus.score;
  const total=hScore+aScore || 1;
  let pHome=(hScore/total)*100;
  let pAway=100-pHome;

  const clamp=(p)=>p<35?35:p>65?65:p;
  pHome=clamp(pHome);
  pAway=100-pHome;

  const ruling=RULING_BIRDS[pak][dayIdx];
  const friendlyR=FRIENDLY_BIRDS[ruling]||[];
  const enemyR=UNFRIENDLY_BIRDS[ruling]||[];

  function birdBonus(b){
    if(b===ruling) return 6;
    if(friendlyR.includes(b)) return 3;
    if(enemyR.includes(b)) return -4;
    return 0;
  }
  pHome += birdBonus(homeBird);
  pAway += birdBonus(awayBird);
  const s=pHome+pAway;
  pHome=(pHome/s)*100;
  pAway=100-pHome;

  const barHtml = makeBar(pHome,pAway,`${home} ${pHome.toFixed(1)}%`,`${away} ${pAway.toFixed(1)}%`);

  $('teamBirdsLine').innerHTML =
    `<span class="tag tag-flow">Team birds (lock)</span>`+
    `<span class="team1-text">${home}</span> ‚Üí ${homeBird} ¬∑ `+
    `<span class="team2-text">${away}</span> ‚Üí ${awayBird}`;

  $('flowBarLine').innerHTML =
    `<span class="tag tag-flow">Match flow (Panchapakshi)</span>`+barHtml+
    `<div class="summary-line">Home activity: <b>${hStatus.activity}</b> ¬∑ Away activity: <b>${aStatus.activity}</b></div>`;

  /* DRAW RULE ‚Äì stronger: */
  let drawYes=false;
  const diff=Math.abs(pHome-pAway);
  if(diff<=8) drawYes=true;
  if(hStatus.activity===aStatus.activity) drawYes=true;
  const weakActs=['Sleep','Die'];
  if(weakActs.includes(hStatus.activity) && weakActs.includes(aStatus.activity)) drawYes=true;

  const drawText = drawYes
    ? 'YES ‚Äì energies nearly equal or both weak.'
    : 'NO ‚Äì one bird clearly stronger.';
  $('drawLine').innerHTML =
    `<span class="tag tag-draw">Draw?</span> ${drawText}`;

  let scoreHint='';
  if(drawYes){
    scoreHint='1‚Äì1 or 2‚Äì2 (draw side).';
  }else if(pHome>pAway){
    scoreHint='Home win: 1‚Äì0 or 2‚Äì1.';
  }else{
    scoreHint='Away win: 0‚Äì2 or 1‚Äì3.';
  }
  $('scoreHintLine').innerHTML =
    `<span class="tag tag-score">Correct score hint</span> ${scoreHint}`;

  let overallWinner='Balanced / 50-50';
  if(pHome>pAway+1)overallWinner=home;
  else if(pAway>pHome+1)overallWinner=away;

  $('overallLine').innerHTML =
    `<span class="tag tag-overall">Overall winner</span>`+
    `<span class="winner-name">${overallWinner}</span> `+
    `‚Ä¢ <span class="team1-text">${home}</span> ${pHome.toFixed(1)}% ¬∑ `+
    `<span class="team2-text">${away}</span> ${pAway.toFixed(1)}%`;

  $('finalCallLine').innerHTML =
    `Final call: <span class="winner-name">${overallWinner}</span>`+
    (drawYes ? ' (draw side strong)' : '');

  const yourCall = drawYes
    ? (overallWinner==='Balanced / 50-50'
        ? 'Balanced / 50-50 (Draw lean)'
        : overallWinner+' + Draw side')
    : overallWinner;

  historyList.push({
    date:dateStr,
    match:`${home} vs ${away}`,
    call:yourCall,
    finalScore:'-',
    status:'Pending',
    fixtureId:currentFixtureId||null
  });
  saveHistory();
  renderHistory();
}

/* ---------- Update finished results via API ---------- */
async function updateFinishedResults(){
  API_KEY = $('apiKey').value.trim();
  if(!API_KEY){alert('Enter API key first.');return;}
  const toUpdate = historyList.filter(h=>h.fixtureId && (h.status==='Pending' || !h.status));
  if(!toUpdate.length){alert('No predictions with fixture id to update.');return;}
  for(const h of toUpdate){
    try{
      const url=`https://v3.football.api-sports.io/fixtures?id=${h.fixtureId}`;
      const res=await fetch(url,{headers:{'x-apisports-key':API_KEY}});
      const data=await res.json();
      const fx=data.response?.[0];
      if(!fx) continue;
      const goals=fx.goals;
      const homeG=goals.home;
      const awayG=goals.away;
      if(homeG===null || awayG===null) continue;
      h.finalScore=`${homeG} ‚Äì ${awayG}`;
      const isDraw = homeG===awayG;
      const call=h.call||'';
      let result='Neutral';
      if(isDraw && call.toLowerCase().includes('draw')) result='Pass';
      else if(!isDraw && call.includes(fx.teams.home.name) && homeG>awayG) result='Pass';
      else if(!isDraw && call.includes(fx.teams.away.name) && awayG>homeG) result='Pass';
      else if(call.startsWith('Balanced / 50-50')) result='Neutral';
      else result='Fail';
      h.status=result;
    }catch(e){
      console.error(e);
    }
  }
  saveHistory();
  renderHistory();
}

/* ---------- init ---------- */
(function init(){
  const today=new Date().toISOString().split('T')[0];
  $('matchDay').value=today;
  $('kickoffDate').value=today;
  $('btnLoadMatches').addEventListener('click',loadMatches);
  $('btnAutoBirds').addEventListener('click',autoTeamBirds);
  $('btnPredict').addEventListener('click',runPrediction);
  $('paksha').addEventListener('change',updateDayBirdLine);
  $('kickoffDate').addEventListener('change',()=>{
    const pk=autoPakshaFromDateStr($('kickoffDate').value);
    $('paksha').value=pk;
    updateDayBirdLine();
  });
  $('btnUpdateResults').addEventListener('click',updateFinishedResults);
  $('btnClearHistory').addEventListener('click',clearHistory);
  window.deleteHistoryRow = deleteHistoryRow; // for onclick
  loadHistory();
  updateDayBirdLine();
})();
</script>
</body>
</html>
